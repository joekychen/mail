<!DOCTYPE html>
<html><head><title>joekychen/mail » lib › mail › body.rb

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>body.rb</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>encoding: utf-8</p></td><td class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">Mail</span>
  </pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>= Body</p>

<p>The body is where the text of the email is stored.  Mail treats the body
as a single object.  The body itself has no information about boundaries
used in the MIME standard, it just looks at it's content as either a single
block of text, or (if it is a multipart message) as an array of blocks of text.</p>

<p>A body has to be told to split itself up into a multipart message by calling</p>

<h1>split with the correct boundary.  This is because the body object has no way</h1>

<p>of knowing what the correct boundary is for itself (there could be many
boundaries in a body in the case of a nested MIME text).</p>

<p>Once split is called, Mail::Body will slice itself up on this boundary,
assigning anything that appears before the first part to the preamble, and
anything that appears after the closing boundary to the epilogue, then
each part gets initialized into a Mail::Part object.</p>

<p>The boundary that is used to split up the Body is also stored in the Body
object for use on encoding itself back out to a string.  You can 
overwrite this if it needs to be changed.</p>

<p>On encoding, the body will return the preamble, then each part joined by
the boundary, followed by a closing boundary string and then the epilogue.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">class</span> <span class="nc">Body</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
      <span class="vi">@boundary</span> <span class="o">=</span> <span class="kp">nil</span>
      <span class="vi">@preamble</span> <span class="o">=</span> <span class="kp">nil</span>
      <span class="vi">@epilogue</span> <span class="o">=</span> <span class="kp">nil</span>
      <span class="vi">@charset</span>  <span class="o">=</span> <span class="kp">nil</span>
      <span class="vi">@part_sort_order</span> <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">,</span> <span class="s2">&quot;text/enriched&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span> <span class="o">]</span>
      <span class="vi">@parts</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">PartsList</span><span class="o">.</span><span class="n">new</span>
      <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">blank?</span>
        <span class="vi">@raw_source</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
      <span class="k">else</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Do join first incase we have been given an Array in Ruby 1.9</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:join</span><span class="p">)</span>
          <span class="vi">@raw_source</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elsif</span> <span class="n">string</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:to_s</span><span class="p">)</span>
          <span class="vi">@raw_source</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">to_s</span>
        <span class="k">else</span>
          <span class="k">raise</span> <span class="s2">&quot;You can only assign a string or an object that responds_to? :join or :to_s to a body.&quot;</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="vi">@encoding</span> <span class="o">=</span> <span class="p">(</span><span class="n">only_us_ascii?</span> <span class="p">?</span> <span class="s1">&#39;7bit&#39;</span> <span class="p">:</span> <span class="s1">&#39;8bit&#39;</span><span class="p">)</span>
      <span class="n">set_charset</span>
    <span class="k">end</span>
    </pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Matches this body with another body.  Also matches the decoded value of this
body with a string.</p>

<p>Examples:</p>

<p>body = Mail::Body.new('The body')
  body == body #=> true</p>

<p>body = Mail::Body.new('The body')
  body == 'The body' #=> true</p>

<p>body = Mail::Body.new("VGhlIGJvZHk=\n")
  body.encoding = 'base64'
  body == "The body" #=> true</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">==</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">class</span> <span class="o">==</span> <span class="nb">String</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">decoded</span> <span class="o">==</span> <span class="n">other</span>
      <span class="k">else</span>
        <span class="k">super</span>
      <span class="k">end</span>
    <span class="k">end</span>
    </pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Accepts a string and performs a regular expression against the decoded text</p>

<p>Examples:</p>

<p>body = Mail::Body.new('The body')
  body =~ /The/ #=> 0</p>

<p>body = Mail::Body.new("VGhlIGJvZHk=\n")
  body.encoding = 'base64'
  body =~ /The/ #=> 0</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="o">=~</span><span class="p">(</span><span class="n">regexp</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">decoded</span> <span class="o">=~</span> <span class="n">regexp</span>
    <span class="k">end</span>
    </pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Accepts a string and performs a regular expression against the decoded text</p>

<p>Examples:</p>

<p>body = Mail::Body.new('The body')
  body.match(/The/) #=> #<MatchData "The"></p>

<p>body = Mail::Body.new("VGhlIGJvZHk=\n")
  body.encoding = 'base64'
  body.match(/The/) #=> #<MatchData "The"></p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">regexp</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">decoded</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regexp</span><span class="p">)</span>
    <span class="k">end</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Accepts anything that responds to #to_s and checks if it's a substring of the decoded text</p>

<p>Examples:</p>

<p>body = Mail::Body.new('The body')
  body.include?('The') #=> true</p>

<p>body = Mail::Body.new("VGhlIGJvZHk=\n")
  body.encoding = 'base64'
  body.include?('The') #=> true</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">include?</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">decoded</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
    <span class="k">end</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Allows you to set the sort order of the parts, overriding the default sort order.
Defaults to 'text/plain', then 'text/enriched', then 'text/html' with any other content
type coming after.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">set_sort_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
      <span class="vi">@part_sort_order</span> <span class="o">=</span> <span class="n">order</span>
    <span class="k">end</span>
    </pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Allows you to sort the parts according to the default sort order, or the sort order you
set with :set<em>sort</em>order.</p>

<p>sort_parts! is also called from :encode, so there is no need for you to call this explicitly</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">sort_parts!</span>
      <span class="vi">@parts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
        <span class="nb">p</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">set_sort_order</span><span class="p">(</span><span class="vi">@part_sort_order</span><span class="p">)</span>
        <span class="vi">@parts</span><span class="o">.</span><span class="n">sort!</span><span class="p">(</span><span class="vi">@part_sort_order</span><span class="p">)</span>
        <span class="nb">p</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">sort_parts!</span>
      <span class="k">end</span>
    <span class="k">end</span>
    </pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Returns the raw source that the body was initialized with, without
any tampering</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">raw_source</span>
      <span class="vi">@raw_source</span>
    <span class="k">end</span>
   
    <span class="k">def</span> <span class="nf">get_best_encoding</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
      <span class="n">target_encoding</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Encodings</span><span class="o">.</span><span class="n">get_encoding</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
      <span class="n">target_encoding</span><span class="o">.</span><span class="n">get_best_compatible</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">raw_source</span><span class="p">)</span>
    <span class="k">end</span>
 </pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Returns a body encoded using transfer_encoding.  Multipart always uses an
identiy encoding (i.e. no encoding).
Calling this directly is not a good idea, but supported for compatibility
TODO: Validate that preamble and epilogue are valid for requested encoding</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">encoded</span><span class="p">(</span><span class="n">transfer_encoding</span> <span class="o">=</span> <span class="s1">&#39;8bit&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">multipart?</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">sort_parts!</span>
        <span class="n">encoded_parts</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="o">.</span><span class="n">encoded</span> <span class="p">}</span>
        <span class="p">(</span><span class="o">[</span><span class="n">preamble</span><span class="o">]</span> <span class="o">+</span> <span class="n">encoded_parts</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">crlf_boundary</span><span class="p">)</span> <span class="o">+</span> <span class="n">end_boundary</span> <span class="o">+</span> <span class="n">epilogue</span><span class="o">.</span><span class="n">to_s</span>
      <span class="k">else</span>
        <span class="n">be</span> <span class="o">=</span> <span class="n">get_best_encoding</span><span class="p">(</span><span class="n">transfer_encoding</span><span class="p">)</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Encodings</span><span class="o">::</span><span class="n">get_encoding</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Encodings</span><span class="o">::</span><span class="n">get_encoding</span><span class="p">(</span><span class="n">be</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">transfer_encoding</span> <span class="o">==</span> <span class="n">encoding</span> <span class="ow">and</span> <span class="n">dec</span><span class="o">.</span><span class="n">nil?</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Cannot decode, so skip normalization</p></td><td class="code"><div class="highlight"><pre>            <span class="n">raw_source</span>
        <span class="k">else</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Decode then encode to normalize and allow transforming 
from base64 to Q-P and vice versa</p></td><td class="code"><div class="highlight"><pre>            <span class="n">decoded</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">raw_source</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">Encoding</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">charset</span> <span class="o">&amp;&amp;</span> <span class="n">charset</span> <span class="o">!=</span> <span class="s2">&quot;US-ASCII&quot;</span>
              <span class="n">decoded</span><span class="o">.</span><span class="n">encode!</span><span class="p">(</span><span class="n">charset</span><span class="p">)</span>
              <span class="n">decoded</span><span class="o">.</span><span class="n">force_encoding</span><span class="p">(</span><span class="s1">&#39;BINARY&#39;</span><span class="p">)</span> <span class="k">unless</span> <span class="no">Encoding</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">charset</span><span class="p">)</span><span class="o">.</span><span class="n">ascii_compatible?</span>
            <span class="k">end</span>
            <span class="n">enc</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
    
    <span class="k">def</span> <span class="nf">decoded</span>
      <span class="k">if</span> <span class="o">!</span><span class="no">Encodings</span><span class="o">.</span><span class="n">defined?</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">raise</span> <span class="no">UnknownEncodingType</span><span class="p">,</span> <span class="s2">&quot;Don&#39;t know how to decode </span><span class="si">#{</span><span class="n">encoding</span><span class="si">}</span><span class="s2">, please call #encoded and decode it yourself.&quot;</span>
      <span class="k">else</span>
        <span class="no">Encodings</span><span class="o">.</span><span class="n">get_encoding</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">raw_source</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
    
    <span class="k">def</span> <span class="nf">to_s</span>
      <span class="n">decoded</span>
    <span class="k">end</span>
    
    <span class="k">def</span> <span class="nf">charset</span>
      <span class="vi">@charset</span>
    <span class="k">end</span>
    
    <span class="k">def</span> <span class="nf">charset</span><span class="o">=</span><span class="p">(</span> <span class="n">val</span> <span class="p">)</span>
      <span class="vi">@charset</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">encoding</span><span class="p">(</span><span class="n">val</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">val</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">val</span>
      <span class="k">else</span>
        <span class="vi">@encoding</span>
      <span class="k">end</span>
    <span class="k">end</span>
    
    <span class="k">def</span> <span class="nf">encoding</span><span class="o">=</span><span class="p">(</span> <span class="n">val</span> <span class="p">)</span>
      <span class="vi">@encoding</span> <span class="o">=</span> <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span> <span class="o">||</span> <span class="n">val</span><span class="o">.</span><span class="n">blank?</span>
          <span class="p">(</span><span class="n">only_us_ascii?</span> <span class="p">?</span> <span class="s1">&#39;7bit&#39;</span> <span class="p">:</span> <span class="s1">&#39;8bit&#39;</span><span class="p">)</span>
      <span class="k">else</span>
          <span class="n">val</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Returns the preamble (any text that is before the first MIME boundary)</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">preamble</span>
      <span class="vi">@preamble</span>
    <span class="k">end</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Sets the preamble to a string (adds text before the first MIME boundary)</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">preamble</span><span class="o">=</span><span class="p">(</span> <span class="n">val</span> <span class="p">)</span>
      <span class="vi">@preamble</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">end</span>
    </pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Returns the epilogue (any text that is after the last MIME boundary)</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">epilogue</span>
      <span class="vi">@epilogue</span>
    <span class="k">end</span>
    </pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Sets the epilogue to a string (adds text after the last MIME boundary)</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">epilogue</span><span class="o">=</span><span class="p">(</span> <span class="n">val</span> <span class="p">)</span>
      <span class="vi">@epilogue</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">end</span>
    </pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Returns true if there are parts defined in the body</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">multipart?</span>
      <span class="kp">true</span> <span class="k">unless</span> <span class="n">parts</span><span class="o">.</span><span class="n">empty?</span>
    <span class="k">end</span>
    </pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Returns the boundary used by the body</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">boundary</span>
      <span class="vi">@boundary</span>
    <span class="k">end</span>
    </pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Allows you to change the boundary of this Body object</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">boundary</span><span class="o">=</span><span class="p">(</span> <span class="n">val</span> <span class="p">)</span>
      <span class="vi">@boundary</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parts</span>
      <span class="vi">@parts</span>
    <span class="k">end</span>
    
    <span class="k">def</span> <span class="nf">&lt;&lt;</span><span class="p">(</span> <span class="n">val</span> <span class="p">)</span>
      <span class="k">if</span> <span class="vi">@parts</span>
        <span class="vi">@parts</span> <span class="o">&lt;&lt;</span> <span class="n">val</span>
      <span class="k">else</span>
        <span class="vi">@parts</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">PartsList</span><span class="o">.</span><span class="n">new</span><span class="o">[</span><span class="n">val</span><span class="o">]</span>
      <span class="k">end</span>
    <span class="k">end</span>
    
    <span class="k">def</span> <span class="nf">split!</span><span class="p">(</span><span class="n">boundary</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">boundary</span> <span class="o">=</span> <span class="n">boundary</span>
      <span class="n">parts</span> <span class="o">=</span> <span class="n">raw_source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;--</span><span class="si">#{</span><span class="n">boundary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Make the preamble equal to the preamble (if any)</p></td><td class="code"><div class="highlight"><pre>      <span class="nb">self</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">to_s</span><span class="o">.</span><span class="n">strip</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Make the epilogue equal to the epilogue (if any)</p></td><td class="code"><div class="highlight"><pre>      <span class="nb">self</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">parts</span><span class="o">[-</span><span class="mi">1</span><span class="o">].</span><span class="n">to_s</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span>
      <span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">-</span><span class="mi">1</span><span class="o">].</span><span class="n">to_a</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">part</span><span class="o">|</span> <span class="vi">@parts</span> <span class="o">&lt;&lt;</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="p">}</span>
      <span class="nb">self</span>
    <span class="k">end</span>
    
    <span class="k">def</span> <span class="nf">only_us_ascii?</span>
      <span class="o">!</span><span class="p">(</span><span class="n">raw_source</span> <span class="o">=~</span> <span class="sr">/[^\x01-\x7f]/</span><span class="p">)</span>
    <span class="k">end</span>
    
    <span class="k">def</span> <span class="nf">empty?</span>
      <span class="o">!!</span><span class="n">raw_source</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">empty?</span>
    <span class="k">end</span>
    
    <span class="kp">private</span>
    
    <span class="k">def</span> <span class="nf">crlf_boundary</span>
      <span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">--</span><span class="si">#{</span><span class="n">boundary</span><span class="si">}</span><span class="se">\r\n</span><span class="s2">&quot;</span>
    <span class="k">end</span>
    
    <span class="k">def</span> <span class="nf">end_boundary</span>
      <span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">--</span><span class="si">#{</span><span class="n">boundary</span><span class="si">}</span><span class="s2">--</span><span class="se">\r\n</span><span class="s2">&quot;</span>
    <span class="k">end</span>
    
    <span class="k">def</span> <span class="nf">set_charset</span>
      <span class="n">only_us_ascii?</span> <span class="p">?</span> <span class="vi">@charset</span> <span class="o">=</span> <span class="s1">&#39;US-ASCII&#39;</span> <span class="p">:</span> <span class="vi">@charset</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/mail",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
