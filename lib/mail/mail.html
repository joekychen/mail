<!DOCTYPE html>
<html><head><title>joekychen/mail » lib › mail › mail.rb

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>mail.rb</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>encoding: utf-8</p></td><td class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">Mail</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Allows you to create a new Mail::Message object.</p>

<p>You can make an email via passing a string or passing a block.</p>

<p>For example, the following two examples will create the same email
message:</p>

<p>Creating via a string:</p>

<p>string = "To: mikel@test.lindsaar.net\r\n"
 string &lt;&lt; "From: bob@test.lindsaar.net\r\n"
 string &lt;&lt; "Subject: This is an email\r\n"
 string &lt;&lt; "\r\n"
 string &lt;&lt; "This is the body"
 Mail.new(string)</p>

<p>Or creating via a block:</p>

<p>message = Mail.new do
   to 'mikel@test.lindsaar.net'
   from 'bob@test.lindsaar.net'
   subject 'This is an email'
   body 'This is the body'
 end</p>

<p>Or creating via a hash (or hash like object):</p>

<p>message = Mail.new({:to => 'mikel@test.lindsaar.net',
                     'from' => 'bob@test.lindsaar.net',
                     :subject => 'This is an email',
                     :body => 'This is the body' })</p>

<p>Note, the hash keys can be strings or symbols, the passed in object
does not need to be a hash, it just needs to respond to :each_pair
and yield each key value pair.</p>

<p>As a side note, you can also create a new email through creating
a Mail::Message object directly and then passing in values via string,
symbol or direct method calls.  See Mail::Message for more information.</p>

<p>mail = Mail.new
 mail.to = 'mikel@test.lindsaar.net'
 mail[:from] = 'bob@test.lindsaar.net'
 mail['subject'] = 'This is an email'
 mail.body = 'This is the body'</p></td><td class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">new</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Sets the default delivery method and retriever method for all new Mail objects.
The delivery<em>method and retriever</em>method default to :smtp and :pop3, with defaults
set.</p>

<p>So sending a new email, if you have an SMTP server running on localhost is
as easy as:</p>

<p>Mail.deliver do
    to      'mikel@test.lindsaar.net'
    from    'bob@test.lindsaar.net'
    subject 'hi there!'
    body    'this is a body'
  end</p>

<p>If you do not specify anything, you will get the following equivalent code set in
every new mail object:</p>

<p>Mail.defaults do
    delivery<em>method :smtp, { :address              => "localhost",
                             :port                 => 25,
                             :domain               => 'localhost.localdomain',
                             :user</em>name            => nil,
                             :password             => nil,
                             :authentication       => nil,
                             :enable<em>starttls</em>auto => true  }</p>

<pre><code>retriever_method :pop3, { :address             =&gt; "localhost",
                          :port                =&gt; 995,
                          :user_name           =&gt; nil,
                          :password            =&gt; nil,
                          :enable_ssl          =&gt; true }
</code></pre>

<p>end</p>

<p>Mail.delivery<em>method.new  #=> Mail::SMTP instance
  Mail.retriever</em>method.new #=> Mail::POP3 instance</p>

<p>Each mail object inherits the default set in Mail.delivery_method, however, on
a per email basis, you can override the method:</p>

<p>mail.delivery_method :sendmail</p>

<p>Or you can override the method and pass in settings:</p>

<p>mail.delivery_method :sendmail, { :address => 'some.host' }</p>

<p>You can also just modify the settings:</p>

<p>mail.delivery_settings = { :address => 'some.host' }</p>

<p>The passed in hash is just merged against the defaults with +merge!+ and the result
assigned the mail object.  So the above example will change only the :address value
of the global smtp_settings to be 'some.host', keeping all other values</p></td><td class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">defaults</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="no">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Returns the delivery method selected, defaults to an instance of Mail::SMTP</p></td><td class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">delivery_method</span>
    <span class="no">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">delivery_method</span>
  <span class="k">end</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Returns the retriever method selected, defaults to an instance of Mail::POP3</p></td><td class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">retriever_method</span>
    <span class="no">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">retriever_method</span>
  <span class="k">end</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Send an email using the default configuration.  You do need to set a default
configuration first before you use self.deliver, if you don't, an appropriate
error will be raised telling you to.</p>

<p>If you do not specify a delivery type, SMTP will be used.</p>

<p>Mail.deliver do
  to 'mikel@test.lindsaar.net'
  from 'ada@test.lindsaar.net'
  subject 'This is a test email'
  body 'Not much to say here'
 end</p>

<p>You can also do:</p>

<p>mail = Mail.read('email.eml')
 mail.deliver!</p>

<p>And your email object will be created and sent.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">deliver</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">deliver</span>
    <span class="n">mail</span>
  <span class="k">end</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Find emails from the default retriever
See Mail::Retriever for a complete documentation.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">retriever_method</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Finds and then deletes retrieved emails from the default retriever
See Mail::Retriever for a complete documentation.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_and_delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">retriever_method</span><span class="o">.</span><span class="n">find_and_delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Receive the first email(s) from the default retriever
See Mail::Retriever for a complete documentation.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">retriever_method</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Receive the first email(s) from the default retriever
See Mail::Retriever for a complete documentation.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">last</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">retriever_method</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Receive all emails from the default retriever
See Mail::Retriever for a complete documentation.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">all</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">retriever_method</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Reads in an email message from a path and instantiates it as a new Mail::Message</p></td><td class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span> <span class="p">})</span>
  <span class="k">end</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Delete all emails from the default retriever
See Mail::Retriever for a complete documentation.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">delete_all</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">retriever_method</span><span class="o">.</span><span class="n">delete_all</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Instantiates a new Mail::Message using a string</p></td><td class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">Mail</span><span class="o">.</span><span class="nf">read_from_string</span><span class="p">(</span><span class="n">mail_as_string</span><span class="p">)</span>
    <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">mail_as_string</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">Mail</span><span class="o">.</span><span class="nf">connection</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">retriever_method</span><span class="o">.</span><span class="n">connection</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Initialize the observers and interceptors arrays</p></td><td class="code"><div class="highlight"><pre>  <span class="vc">@@delivery_notification_observers</span> <span class="o">=</span> <span class="o">[]</span>
  <span class="vc">@@delivery_interceptors</span> <span class="o">=</span> <span class="o">[]</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>You can register an object to be informed of every email that is sent through
this method.</p>

<p>Your object needs to respond to a single method #delivered_email(mail)
which receives the email that is sent.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">register_observer</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
    <span class="k">unless</span> <span class="vc">@@delivery_notification_observers</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
      <span class="vc">@@delivery_notification_observers</span> <span class="o">&lt;&lt;</span> <span class="n">observer</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>You can register an object to be given every mail object that will be sent,
before it is sent.  So if you want to add special headers or modify any
email that gets sent through the Mail library, you can do so.</p>

<p>Your object needs to respond to a single method #delivering_email(mail)
which receives the email that is about to be sent.  Make your modifications
directly to this object.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">register_interceptor</span><span class="p">(</span><span class="n">interceptor</span><span class="p">)</span>
    <span class="k">unless</span> <span class="vc">@@delivery_interceptors</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">interceptor</span><span class="p">)</span>
      <span class="vc">@@delivery_interceptors</span> <span class="o">&lt;&lt;</span> <span class="n">interceptor</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">inform_observers</span><span class="p">(</span><span class="n">mail</span><span class="p">)</span>
    <span class="vc">@@delivery_notification_observers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">observer</span><span class="o">|</span>
      <span class="n">observer</span><span class="o">.</span><span class="n">delivered_email</span><span class="p">(</span><span class="n">mail</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">inform_interceptors</span><span class="p">(</span><span class="n">mail</span><span class="p">)</span>
    <span class="vc">@@delivery_interceptors</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">interceptor</span><span class="o">|</span>
      <span class="n">interceptor</span><span class="o">.</span><span class="n">delivering_email</span><span class="p">(</span><span class="n">mail</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">random_tag</span>
    <span class="n">t</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
    <span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;%x%x_%x%x%d%x&#39;</span><span class="p">,</span>
            <span class="n">t</span><span class="o">.</span><span class="n">to_i</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">tv_usec</span><span class="p">,</span>
            <span class="vg">$$</span><span class="p">,</span> <span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">object_id</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">uniq</span><span class="p">,</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">something_random</span>
    <span class="p">(</span><span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">object_id</span> <span class="o">*</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="o">/</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_f</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">uniq</span>
    <span class="vc">@@uniq</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>

  <span class="vc">@@uniq</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">something_random</span>

<span class="k">end</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/mail",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
