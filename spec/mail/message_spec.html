<!DOCTYPE html>
<html><head><title>joekychen/mail » spec › mail › message_spec.rb

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>message_spec.rb</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>encoding: utf-8</p></td><td class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span> <span class="k">do</span>

  <span class="k">def</span> <span class="nf">basic_email</span>
    <span class="s2">&quot;To: mikel</span><span class="se">\r\n</span><span class="s2">From: bob</span><span class="se">\r\n</span><span class="s2">Subject: Hello!</span><span class="se">\r\n\r\n</span><span class="s2">email message</span><span class="se">\r\n</span><span class="s2">&quot;</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;initialization&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should instantiate empty&quot;</span> <span class="k">do</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should return a basic email&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_blank</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">message_id</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_blank</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">mime_version</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;1.0&quot;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;text/plain&quot;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">content_transfer_encoding</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;7bit&quot;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">should</span> <span class="n">be_blank</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">should</span> <span class="n">be_blank</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should instantiate with a string&quot;</span> <span class="k">do</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">basic_email</span><span class="p">)</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should allow us to pass it a block&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
        <span class="n">from</span> <span class="s1">&#39;mikel@me.com&#39;</span>
        <span class="n">to</span> <span class="s1">&#39;lindsaar@you.com&#39;</span>
      <span class="k">end</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@me.com&#39;</span><span class="o">]</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;lindsaar@you.com&#39;</span><span class="o">]</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should initialize a body and header class even if called with nothing to begin with&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Header</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Body</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should not report basic emails as bounced&quot;</span> <span class="k">do</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_bounced</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should be able to parse a basic email&quot;</span> <span class="k">do</span>
      <span class="n">doing</span> <span class="p">{</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;plain_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;basic_email.eml&#39;</span><span class="p">)))</span> <span class="p">}</span><span class="o">.</span><span class="n">should_not</span> <span class="n">raise_error</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should be able to parse an email with @ in display name&quot;</span> <span class="k">do</span>
      <span class="n">message</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;plain_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_email_with_at_display_name.eml&#39;</span><span class="p">)))</span>
      <span class="n">message</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;smith@gmail.com&quot;</span><span class="p">,</span> <span class="s2">&quot;raasdnil@gmail.com&quot;</span><span class="p">,</span> <span class="s2">&quot;tom@gmail.com&quot;</span><span class="o">]</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should be able to parse an email with only blank lines as body&quot;</span> <span class="k">do</span>
      <span class="n">doing</span> <span class="p">{</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;error_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;missing_body.eml&#39;</span><span class="p">)))</span> <span class="p">}</span><span class="o">.</span><span class="n">should_not</span> <span class="n">raise_error</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should be able to parse an email with a funky date header&quot;</span> <span class="k">do</span>
      <span class="n">doing</span> <span class="p">{</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;error_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;bad_date_header2.eml&#39;</span><span class="p">)))</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">&#39;should be able to invoke subject on a funky subject header&#39;</span> <span class="k">do</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;error_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;bad_subject.eml&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">subject</span>
    <span class="k">end</span>


    <span class="n">it</span> <span class="s1">&#39;should be able to parse an email missing an encoding&#39;</span> <span class="k">do</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;error_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;must_supply_encoding.eml&#39;</span><span class="p">)))</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should be able to parse every email example we have without raising an exception&quot;</span> <span class="k">do</span>
      <span class="n">emails</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span> <span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails/**/*&#39;</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">delete_if</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="no">File</span><span class="o">.</span><span class="n">directory?</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">}</span>

      <span class="no">STDERR</span><span class="o">.</span><span class="n">stub!</span><span class="p">(</span><span class="ss">:puts</span><span class="p">)</span> <span class="c1"># Don&#39;t want to get noisy about any warnings</span>
      <span class="n">errors</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="n">expected_failures</span> <span class="o">=</span> <span class="o">[]</span>
      <span class="n">emails</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">email</span><span class="o">|</span>
        <span class="k">begin</span>
          <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">email</span><span class="p">))</span>
        <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
          <span class="k">unless</span> <span class="n">expected_failures</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="nb">puts</span> <span class="s2">&quot;Failed on email </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="nb">puts</span> <span class="s2">&quot;Failure was:</span><span class="se">\n</span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="kp">true</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="n">errors</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should not raise a warning on having non US-ASCII characters in the header (should just handle it)&quot;</span> <span class="k">do</span>
      <span class="no">STDERR</span><span class="o">.</span><span class="n">should_not_receive</span><span class="p">(</span><span class="ss">:puts</span><span class="p">)</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;plain_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_email_string_in_date_field.eml&#39;</span><span class="p">)))</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should raise a warning (and keep parsing) on having an incorrectly formatted header&quot;</span> <span class="k">do</span>
      <span class="no">STDERR</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:puts</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s2">&quot;WARNING: Could not parse (and so ignorning) &#39;quite Delivered-To: xxx@xxx.xxx&#39;&quot;</span><span class="p">)</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;plain_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_email_incorrect_header.eml&#39;</span><span class="p">)))</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should read in an email message and basically parse it&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;plain_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;basic_email.eml&#39;</span><span class="p">)))</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;raasdnil@gmail.com&quot;</span><span class="o">]</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should not fail parsing message with caps in content_type&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;plain_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;mix_caps_content_type.eml&#39;</span><span class="p">)))</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;text/plain; charset=iso-8859-1&#39;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">main_type</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;text&#39;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">sub_type</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;plain&#39;</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should be able to pass an empty reply-to header&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;error_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;empty_in_reply_to.eml&#39;</span><span class="p">)))</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">in_reply_to</span><span class="o">.</span><span class="n">should</span> <span class="n">be_blank</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;YAML serialization&quot;</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@yaml_mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;someone@somewhere.com&#39;</span><span class="p">,</span>
                                  <span class="ss">:cc</span> <span class="o">=&gt;</span> <span class="s1">&#39;someoneelse@somewhere.com&#39;</span><span class="p">,</span>
                                  <span class="ss">:bcc</span> <span class="o">=&gt;</span> <span class="s1">&#39;someonesecret@somewhere.com&#39;</span><span class="p">,</span>
                                  <span class="ss">:body</span> <span class="o">=&gt;</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span>
                                  <span class="ss">:subject</span> <span class="o">=&gt;</span> <span class="s1">&#39;subject&#39;</span><span class="p">)</span>
        <span class="vi">@smtp_settings</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:address</span><span class="o">=&gt;</span><span class="s2">&quot;smtp.somewhere.net&quot;</span><span class="p">,</span>
          <span class="ss">:port</span><span class="o">=&gt;</span><span class="s2">&quot;587&quot;</span><span class="p">,</span> <span class="ss">:domain</span><span class="o">=&gt;</span><span class="s2">&quot;somewhere.net&quot;</span><span class="p">,</span> <span class="ss">:user_name</span><span class="o">=&gt;</span><span class="s2">&quot;someone@somewhere.net&quot;</span><span class="p">,</span>
          <span class="ss">:password</span><span class="o">=&gt;</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="ss">:authentication</span><span class="o">=&gt;</span><span class="ss">:plain</span><span class="p">,</span> <span class="ss">:enable_starttls_auto</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
          <span class="ss">:openssl_verify_mode</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span> <span class="ss">:ssl</span><span class="o">=&gt;</span><span class="kp">nil</span><span class="p">,</span> <span class="ss">:tls</span><span class="o">=&gt;</span><span class="kp">nil</span> <span class="p">}</span>
        <span class="vi">@yaml_mail</span><span class="o">.</span><span class="n">delivery_method</span> <span class="ss">:smtp</span><span class="p">,</span> <span class="vi">@smtp_settings</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should serialize the basic information to YAML&quot;</span> <span class="k">do</span>
        <span class="n">yaml</span> <span class="o">=</span> <span class="vi">@yaml_mail</span><span class="o">.</span><span class="n">to_yaml</span>
        <span class="n">yaml_output</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">yaml</span><span class="p">)</span>
        <span class="n">yaml_output</span><span class="o">[</span><span class="s1">&#39;headers&#39;</span><span class="o">][</span><span class="s1">&#39;To&#39;</span><span class="o">].</span><span class="n">should</span>       <span class="n">eq</span> <span class="s2">&quot;someone@somewhere.com&quot;</span>
        <span class="n">yaml_output</span><span class="o">[</span><span class="s1">&#39;headers&#39;</span><span class="o">][</span><span class="s1">&#39;Cc&#39;</span><span class="o">].</span><span class="n">should</span>       <span class="n">eq</span> <span class="s2">&quot;someoneelse@somewhere.com&quot;</span>
        <span class="n">yaml_output</span><span class="o">[</span><span class="s1">&#39;headers&#39;</span><span class="o">][</span><span class="s1">&#39;Subject&#39;</span><span class="o">].</span><span class="n">should</span>  <span class="n">eq</span> <span class="s2">&quot;subject&quot;</span>
        <span class="n">yaml_output</span><span class="o">[</span><span class="s1">&#39;headers&#39;</span><span class="o">][</span><span class="s1">&#39;Bcc&#39;</span><span class="o">].</span><span class="n">should</span>      <span class="n">eq</span> <span class="s2">&quot;someonesecret@somewhere.com&quot;</span>
        <span class="n">yaml_output</span><span class="o">[</span><span class="s1">&#39;@body_raw&#39;</span><span class="o">].</span><span class="n">should</span>           <span class="n">eq</span> <span class="s2">&quot;body&quot;</span>
        <span class="n">yaml_output</span><span class="o">[</span><span class="s1">&#39;@delivery_method&#39;</span><span class="o">].</span><span class="n">should_not</span> <span class="n">be_blank</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should deserialize after serializing&quot;</span> <span class="k">do</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="vi">@yaml_mail</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">)</span>
        <span class="n">deserialized</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="vi">@yaml_mail</span>
        <span class="n">deserialized</span><span class="o">.</span><span class="n">delivery_method</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="vi">@smtp_settings</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should serialize a Message with a custom delivery_handler&quot;</span> <span class="k">do</span>
        <span class="vi">@yaml_mail</span><span class="o">.</span><span class="n">delivery_handler</span> <span class="o">=</span> <span class="no">DeliveryAgent</span>
        <span class="n">yaml</span> <span class="o">=</span> <span class="vi">@yaml_mail</span><span class="o">.</span><span class="n">to_yaml</span>
        <span class="n">yaml_output</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">yaml</span><span class="p">)</span>
        <span class="n">yaml_output</span><span class="o">[</span><span class="s1">&#39;delivery_handler&#39;</span><span class="o">].</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;DeliveryAgent&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should load a serialized delivery handler&quot;</span> <span class="k">do</span>
        <span class="vi">@yaml_mail</span><span class="o">.</span><span class="n">delivery_handler</span> <span class="o">=</span> <span class="no">DeliveryAgent</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="vi">@yaml_mail</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">)</span>
        <span class="n">deserialized</span><span class="o">.</span><span class="n">delivery_handler</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="no">DeliveryAgent</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should not deserialize a delivery_handler that does not exist&quot;</span> <span class="k">do</span>
        <span class="n">yaml</span> <span class="o">=</span> <span class="vi">@yaml_mail</span><span class="o">.</span><span class="n">to_yaml</span>
        <span class="n">yaml_hash</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">yaml</span><span class="p">)</span>
        <span class="n">yaml_hash</span><span class="o">[</span><span class="s1">&#39;delivery_handler&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;NotARealClass&quot;</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="n">yaml_hash</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">)</span>
        <span class="n">deserialized</span><span class="o">.</span><span class="n">delivery_handler</span><span class="o">.</span><span class="n">should</span> <span class="n">be_nil</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should handle multipart mail&quot;</span> <span class="k">do</span>
        <span class="vi">@yaml_mail</span><span class="o">.</span><span class="n">add_part</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="s1">&#39;text/html&#39;</span><span class="p">,</span> <span class="ss">:body</span> <span class="o">=&gt;</span> <span class="s1">&#39;&lt;b&gt;body&lt;/b&gt;&#39;</span><span class="p">)</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="vi">@yaml_mail</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">)</span>
        <span class="n">deserialized</span><span class="o">.</span><span class="n">should</span> <span class="n">be_multipart</span>
        <span class="n">deserialized</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">part</span><span class="o">|</span> <span class="n">part</span><span class="o">.</span><span class="n">should</span> <span class="n">be_a</span><span class="p">(</span><span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="p">)}</span>
        <span class="n">deserialized</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:body</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;b&gt;body&lt;/b&gt;&#39;</span><span class="o">]</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;envelope line handling&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should respond to &#39;envelope from&#39;&quot;</span> <span class="k">do</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:envelope_from</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should strip off the envelope from field if present&quot;</span> <span class="k">do</span>
      <span class="n">message</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;plain_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_email.eml&#39;</span><span class="p">)))</span>
      <span class="n">message</span><span class="o">.</span><span class="n">envelope_from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;jamis_buck@byu.edu&quot;</span>
      <span class="n">message</span><span class="o">.</span><span class="n">envelope_date</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">::</span><span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;Mon May  2 16:07:05 2005&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should strip off the envelope from field if present&quot;</span> <span class="k">do</span>
      <span class="n">message</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;plain_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_email.eml&#39;</span><span class="p">)))</span>
      <span class="n">message</span><span class="o">.</span><span class="n">raw_envelope</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;jamis_buck@byu.edu Mon May  2 16:07:05 2005&quot;</span>
      <span class="n">message</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;jamis@37signals.com&quot;</span><span class="o">]</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should not cause any problems if there is no envelope from present&quot;</span> <span class="k">do</span>
      <span class="n">message</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;plain_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;basic_email.eml&#39;</span><span class="p">)))</span>
      <span class="n">message</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;test@lindsaar.net&quot;</span><span class="o">]</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should ignore a plain text body that starts with ^From&quot;</span> <span class="k">do</span>
      <span class="n">m</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;From: mikel@test.lindsaar.net</span><span class="se">\r\n\r\n</span><span class="s2">This is a way to break mail by putting</span><span class="se">\r\n</span><span class="s2">From at the start of a body</span><span class="se">\r\n</span><span class="s2">or elsewhere.&quot;</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_nil</span>
      <span class="n">m</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@test.lindsaar.net&#39;</span><span class="o">]</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should handle a multipart message that has ^From in it&quot;</span> <span class="k">do</span>
      <span class="n">m</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;error_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;cant_parse_from.eml&#39;</span><span class="p">)))</span>
      <span class="n">m</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_nil</span>
      <span class="n">m</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;News@InsideApple.Apple.com&quot;</span><span class="o">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">should</span> <span class="n">be_multipart</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;accepting a plain text string email&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should accept some email text to parse and return an email&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">basic_email</span><span class="p">)</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should set a raw source instance variable to equal the passed in message&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">basic_email</span><span class="p">)</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">raw_source</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="n">basic_email</span><span class="o">.</span><span class="n">strip</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should set the raw source instance variable to &#39;&#39; if no message is passed in&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">raw_source</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;&quot;</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should give the header class the header to parse&quot;</span> <span class="k">do</span>
      <span class="n">header</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Header</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel</span><span class="se">\r\n</span><span class="s2">From: bob</span><span class="se">\r\n</span><span class="s2">Subject: Hello!&quot;</span><span class="p">)</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Header</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s2">&quot;To: mikel</span><span class="se">\r\n</span><span class="s2">From: bob</span><span class="se">\r\n</span><span class="s2">Subject: Hello!&quot;</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">basic_email</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should give the header class the header to parse even if there is no body&quot;</span> <span class="k">do</span>
      <span class="n">header</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Header</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel</span><span class="se">\r\n</span><span class="s2">From: bob</span><span class="se">\r\n</span><span class="s2">Subject: Hello!&quot;</span><span class="p">)</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Header</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s2">&quot;To: mikel</span><span class="se">\r\n</span><span class="s2">From: bob</span><span class="se">\r\n</span><span class="s2">Subject: Hello!&quot;</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel</span><span class="se">\r\n</span><span class="s2">From: bob</span><span class="se">\r\n</span><span class="s2">Subject: Hello!&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should give the body class the body to parse&quot;</span> <span class="k">do</span>
      <span class="n">body</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Body</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;email message&quot;</span><span class="p">)</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Body</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s2">&quot;email message&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">basic_email</span><span class="p">)</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">body</span> <span class="c1">#body calculates now lazy so need to ask for it</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should still ask the body for a new instance even though these is nothing to parse, yet&quot;</span> <span class="k">do</span>
      <span class="n">body</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Body</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Body</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel</span><span class="se">\r\n</span><span class="s2">From: bob</span><span class="se">\r\n</span><span class="s2">Subject: Hello!&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should give the header the part before the line without spaces and the body the part without&quot;</span> <span class="k">do</span>
      <span class="n">header</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Header</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel&quot;</span><span class="p">)</span>
      <span class="n">body</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Body</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;G&#39;Day!&quot;</span><span class="p">)</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Header</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s2">&quot;To: mikel&quot;</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Body</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s2">&quot;G&#39;Day!&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel</span><span class="se">\r\n\r\n</span><span class="s2">G&#39;Day!&quot;</span><span class="p">)</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">body</span> <span class="c1">#body calculates now lazy so need to ask for it</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should give allow for whitespace on the gap line between header and body&quot;</span> <span class="k">do</span>
      <span class="n">header</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Header</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel&quot;</span><span class="p">)</span>
      <span class="n">body</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Body</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;G&#39;Day!&quot;</span><span class="p">)</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Header</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s2">&quot;To: mikel&quot;</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Body</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s2">&quot;G&#39;Day!&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel</span><span class="se">\r\n</span><span class="s2">   		  </span><span class="se">\r\n</span><span class="s2">G&#39;Day!&quot;</span><span class="p">)</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">body</span> <span class="c1">#body calculates now lazy so need to ask for it</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should allow for whitespace at the start of the email&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">From: mikel</span><span class="se">\r\n\r\n</span><span class="s2">This is the body&quot;</span><span class="p">)</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel&#39;</span><span class="o">]</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;This is the body&#39;</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should read in an email message with the word &#39;From&#39; in it multiple times and parse it&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;mime_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;two_from_in_message.eml&#39;</span><span class="p">)))</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_nil</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;tester2@test.com&quot;</span><span class="o">]</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;directly setting values of a message&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;accessing fields directly&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should allow you to grab field objects if you really want to&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">header_fields</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="no">Mail</span><span class="o">::</span><span class="no">FieldList</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should give you back the fields in the header&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">[</span><span class="s1">&#39;bar&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;abcd&#39;</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">header_fields</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">1</span>
        <span class="vi">@mail</span><span class="o">[</span><span class="s1">&#39;foo&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;4321&#39;</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">header_fields</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">2</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should delete a field if it is set to nil&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">[</span><span class="s1">&#39;foo&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;4321&#39;</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">header_fields</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">1</span>
        <span class="vi">@mail</span><span class="o">[</span><span class="s1">&#39;foo&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">header_fields</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">0</span>
      <span class="k">end</span>

    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with :method=&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should return the to field&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="s2">&quot;mikel&quot;</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;mikel&quot;</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should return the from field&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">from</span> <span class="o">=</span> <span class="s2">&quot;bob&quot;</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;bob&quot;</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should return the subject&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Hello!&quot;</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;Hello!&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should return the body decoded with to_s&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">body</span> <span class="s2">&quot;email message</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;email message</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should return the body encoded if asked for&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">body</span> <span class="s2">&quot;email message</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;email message</span><span class="se">\r\n</span><span class="s2">&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should return the body decoded if asked for&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">body</span> <span class="s2">&quot;email message</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;email message</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with :method(value)&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should return the to field&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">to</span> <span class="s2">&quot;mikel&quot;</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;mikel&quot;</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should return the from field&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">from</span> <span class="s2">&quot;bob&quot;</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;bob&quot;</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should return the subject&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">subject</span> <span class="s2">&quot;Hello!&quot;</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;Hello!&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should return the body decoded with to_s&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">body</span> <span class="s2">&quot;email message</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;email message</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should return the body encoded if asked for&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">body</span> <span class="s2">&quot;email message</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;email message</span><span class="se">\r\n</span><span class="s2">&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should return the body decoded if asked for&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">body</span> <span class="s2">&quot;email message</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;email message</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;setting arbitrary headers&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should allow you to set them&quot;</span> <span class="k">do</span>
        <span class="n">doing</span> <span class="p">{</span><span class="vi">@mail</span><span class="o">[</span><span class="s1">&#39;foo&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1234</span><span class="p">}</span><span class="o">.</span><span class="n">should_not</span> <span class="n">raise_error</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should allow you to read arbitrary headers&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">[</span><span class="s1">&#39;foo&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1234</span>
        <span class="vi">@mail</span><span class="o">[</span><span class="s1">&#39;foo&#39;</span><span class="o">].</span><span class="n">value</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;1234&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should instantiate a new Header&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">[</span><span class="s1">&#39;foo&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1234</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">header_fields</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Field</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;replacing header values&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should allow you to replace a from field&quot;</span> <span class="k">do</span>
        <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="kp">nil</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">from</span> <span class="o">=</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@test.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">from</span> <span class="o">=</span> <span class="s1">&#39;bob@test.lindsaar.net&#39;</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;bob@test.lindsaar.net&#39;</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should maintain the class of the field&quot;</span> <span class="k">do</span>
        <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">from</span> <span class="o">=</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
        <span class="n">mail</span><span class="o">[</span><span class="ss">:from</span><span class="o">].</span><span class="n">field</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="no">Mail</span><span class="o">::</span><span class="no">FromField</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">from</span> <span class="o">=</span> <span class="s1">&#39;bob@test.lindsaar.net&#39;</span>
        <span class="n">mail</span><span class="o">[</span><span class="ss">:from</span><span class="o">].</span><span class="n">field</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="no">Mail</span><span class="o">::</span><span class="no">FromField</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;setting headers&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should accept them in block form&quot;</span> <span class="k">do</span>
        <span class="n">message</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
          <span class="n">bcc</span>           <span class="s1">&#39;mikel@bcc.lindsaar.net&#39;</span>
          <span class="n">cc</span>            <span class="s1">&#39;mikel@cc.lindsaar.net&#39;</span>
          <span class="n">comments</span>      <span class="s1">&#39;this is a comment&#39;</span>
          <span class="n">date</span>          <span class="s1">&#39;12 Aug 2009 00:00:01 GMT&#39;</span>
          <span class="n">from</span>          <span class="s1">&#39;mikel@from.lindsaar.net&#39;</span>
          <span class="n">in_reply_to</span>   <span class="s1">&#39;&lt;1234@in_reply_to.lindsaar.net&gt;&#39;</span>
          <span class="n">keywords</span>      <span class="s1">&#39;test, &quot;of the new mail&quot;, system&#39;</span>
          <span class="n">message_id</span>    <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span>
          <span class="n">received</span>      <span class="s1">&#39;from machine.example by x.y.test; 12 Aug 2009 00:00:02 GMT&#39;</span>
          <span class="n">references</span>    <span class="s1">&#39;&lt;1234@references.lindsaar.net&gt;&#39;</span>
          <span class="n">reply_to</span>      <span class="s1">&#39;mikel@reply-to.lindsaar.net&#39;</span>
          <span class="n">resent_bcc</span>    <span class="s1">&#39;mikel@resent-bcc.lindsaar.net&#39;</span>
          <span class="n">resent_cc</span>     <span class="s1">&#39;mikel@resent-cc.lindsaar.net&#39;</span>
          <span class="n">resent_date</span>   <span class="s1">&#39;12 Aug 2009 00:00:03 GMT&#39;</span>
          <span class="n">resent_from</span>   <span class="s1">&#39;mikel@resent-from.lindsaar.net&#39;</span>
          <span class="n">resent_message_id</span> <span class="s1">&#39;&lt;1234@resent_message_id.lindsaar.net&gt;&#39;</span>
          <span class="n">resent_sender</span> <span class="s1">&#39;mikel@resent-sender.lindsaar.net&#39;</span>
          <span class="n">resent_to</span>     <span class="s1">&#39;mikel@resent-to.lindsaar.net&#39;</span>
          <span class="n">sender</span>        <span class="s1">&#39;mikel@sender.lindsaar.net&#39;</span>
          <span class="n">subject</span>       <span class="s1">&#39;Hello there Mikel&#39;</span>
          <span class="n">to</span>            <span class="s1">&#39;mikel@to.lindsaar.net&#39;</span>
          <span class="n">content_type</span>  <span class="s1">&#39;text/plain; charset=UTF-8&#39;</span>
          <span class="n">content_transfer_encoding</span> <span class="s1">&#39;7bit&#39;</span>
          <span class="n">content_description</span>       <span class="s1">&#39;This is a test&#39;</span>
          <span class="n">content_disposition</span>       <span class="s1">&#39;attachment; filename=File&#39;</span>
          <span class="n">content_id</span>                <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span>
          <span class="n">mime_version</span>  <span class="s1">&#39;1.0&#39;</span>
          <span class="n">body</span>          <span class="s1">&#39;This is a body of text&#39;</span>
        <span class="k">end</span>

        <span class="n">message</span><span class="o">.</span><span class="n">bcc</span><span class="o">.</span><span class="n">should</span>           <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@bcc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">should</span>            <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@cc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="s1">&#39;this is a comment&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:01 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@from.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">in_reply_to</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="s1">&#39;1234@in_reply_to.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;of the new mail&quot;</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">message_id</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="s1">&#39;1234@message_id.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">received</span><span class="o">.</span><span class="n">date_time</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:02 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">references</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="s1">&#39;1234@references.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">reply_to</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@reply-to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_bcc</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-bcc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_cc</span><span class="o">.</span><span class="n">should</span>     <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-cc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_date</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:03 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_from</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-from.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_message_id</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;1234@resent_message_id.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_sender</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-sender.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_to</span><span class="o">.</span><span class="n">should</span>     <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">should</span>        <span class="n">eq</span> <span class="s1">&#39;mikel@sender.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;Hello there Mikel&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span>            <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">should</span>              <span class="n">eq</span> <span class="s1">&#39;text/plain; charset=UTF-8&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_transfer_encoding</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;7bit&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_description</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;This is a test&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_disposition</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;attachment; filename=File&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_id</span><span class="o">.</span><span class="n">should</span>                <span class="n">eq</span> <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">mime_version</span><span class="o">.</span><span class="n">should</span>              <span class="n">eq</span> <span class="s1">&#39;1.0&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="s1">&#39;This is a body of text&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should accept them in assignment form&quot;</span> <span class="k">do</span>
        <span class="n">message</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
        <span class="n">message</span><span class="o">.</span><span class="n">bcc</span> <span class="o">=</span>           <span class="s1">&#39;mikel@bcc.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">cc</span> <span class="o">=</span>            <span class="s1">&#39;mikel@cc.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span>      <span class="s1">&#39;this is a comment&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span>          <span class="s1">&#39;12 Aug 2009 00:00:01 GMT&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">from</span> <span class="o">=</span>          <span class="s1">&#39;mikel@from.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">in_reply_to</span> <span class="o">=</span>   <span class="s1">&#39;&lt;1234@in_reply_to.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span>      <span class="s1">&#39;test, &quot;of the new mail&quot;, system&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">message_id</span> <span class="o">=</span>    <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">received</span> <span class="o">=</span>      <span class="s1">&#39;from machine.example by x.y.test; 12 Aug 2009 00:00:02 GMT&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">references</span> <span class="o">=</span>    <span class="s1">&#39;&lt;1234@references.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">reply_to</span> <span class="o">=</span>      <span class="s1">&#39;mikel@reply-to.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_bcc</span> <span class="o">=</span>    <span class="s1">&#39;mikel@resent-bcc.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_cc</span> <span class="o">=</span>     <span class="s1">&#39;mikel@resent-cc.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_date</span> <span class="o">=</span>   <span class="s1">&#39;12 Aug 2009 00:00:03 GMT&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_from</span> <span class="o">=</span>   <span class="s1">&#39;mikel@resent-from.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_message_id</span> <span class="o">=</span> <span class="s1">&#39;&lt;1234@resent_message_id.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_sender</span> <span class="o">=</span> <span class="s1">&#39;mikel@resent-sender.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_to</span> <span class="o">=</span>     <span class="s1">&#39;mikel@resent-to.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span>        <span class="s1">&#39;mikel@sender.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span>       <span class="s1">&#39;Hello there Mikel&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span>            <span class="s1">&#39;mikel@to.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span>  <span class="s1">&#39;text/plain; charset=UTF-8&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_transfer_encoding</span> <span class="o">=</span> <span class="s1">&#39;7bit&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_description</span> <span class="o">=</span>       <span class="s1">&#39;This is a test&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_disposition</span> <span class="o">=</span>       <span class="s1">&#39;attachment; filename=File&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_id</span> <span class="o">=</span>                <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">mime_version</span> <span class="o">=</span>  <span class="s1">&#39;1.0&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span>          <span class="s1">&#39;This is a body of text&#39;</span>

        <span class="n">message</span><span class="o">.</span><span class="n">bcc</span><span class="o">.</span><span class="n">should</span>           <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@bcc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">should</span>            <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@cc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="s1">&#39;this is a comment&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:01 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@from.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">in_reply_to</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="s1">&#39;1234@in_reply_to.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;of the new mail&quot;</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">message_id</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="s1">&#39;1234@message_id.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">received</span><span class="o">.</span><span class="n">date_time</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:02 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">references</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="s1">&#39;1234@references.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">reply_to</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@reply-to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_bcc</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-bcc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_cc</span><span class="o">.</span><span class="n">should</span>     <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-cc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_date</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:03 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_from</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-from.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_message_id</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;1234@resent_message_id.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_sender</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-sender.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_to</span><span class="o">.</span><span class="n">should</span>     <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">should</span>        <span class="n">eq</span> <span class="s1">&#39;mikel@sender.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;Hello there Mikel&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span>            <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">should</span>              <span class="n">eq</span> <span class="s1">&#39;text/plain; charset=UTF-8&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_transfer_encoding</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;7bit&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_description</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;This is a test&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_disposition</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;attachment; filename=File&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_id</span><span class="o">.</span><span class="n">should</span>                <span class="n">eq</span> <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">mime_version</span><span class="o">.</span><span class="n">should</span>              <span class="n">eq</span> <span class="s1">&#39;1.0&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="s1">&#39;This is a body of text&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should accept them in key, value form as symbols&quot;</span> <span class="k">do</span>
        <span class="n">message</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:bcc</span><span class="o">]</span> <span class="o">=</span>           <span class="s1">&#39;mikel@bcc.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:cc</span><span class="o">]</span> <span class="o">=</span>            <span class="s1">&#39;mikel@cc.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:comments</span><span class="o">]</span> <span class="o">=</span>      <span class="s1">&#39;this is a comment&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:date</span><span class="o">]</span> <span class="o">=</span>          <span class="s1">&#39;12 Aug 2009 00:00:01 GMT&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:from</span><span class="o">]</span> <span class="o">=</span>          <span class="s1">&#39;mikel@from.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:in_reply_to</span><span class="o">]</span> <span class="o">=</span>   <span class="s1">&#39;&lt;1234@in_reply_to.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:keywords</span><span class="o">]</span> <span class="o">=</span>      <span class="s1">&#39;test, &quot;of the new mail&quot;, system&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:message_id</span><span class="o">]</span> <span class="o">=</span>    <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:received</span><span class="o">]</span> <span class="o">=</span>      <span class="s1">&#39;from machine.example by x.y.test; 12 Aug 2009 00:00:02 GMT&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:references</span><span class="o">]</span> <span class="o">=</span>    <span class="s1">&#39;&lt;1234@references.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:reply_to</span><span class="o">]</span> <span class="o">=</span>      <span class="s1">&#39;mikel@reply-to.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:resent_bcc</span><span class="o">]</span> <span class="o">=</span>    <span class="s1">&#39;mikel@resent-bcc.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:resent_cc</span><span class="o">]</span> <span class="o">=</span>     <span class="s1">&#39;mikel@resent-cc.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:resent_date</span><span class="o">]</span> <span class="o">=</span>   <span class="s1">&#39;12 Aug 2009 00:00:03 GMT&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:resent_from</span><span class="o">]</span> <span class="o">=</span>   <span class="s1">&#39;mikel@resent-from.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:resent_message_id</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;1234@resent_message_id.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:resent_sender</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;mikel@resent-sender.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:resent_to</span><span class="o">]</span> <span class="o">=</span>     <span class="s1">&#39;mikel@resent-to.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:sender</span><span class="o">]</span> <span class="o">=</span>        <span class="s1">&#39;mikel@sender.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:subject</span><span class="o">]</span> <span class="o">=</span>       <span class="s1">&#39;Hello there Mikel&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:to</span><span class="o">]</span> <span class="o">=</span>            <span class="s1">&#39;mikel@to.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:content_type</span><span class="o">]</span> <span class="o">=</span>  <span class="s1">&#39;text/plain; charset=UTF-8&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:content_transfer_encoding</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;7bit&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:content_description</span><span class="o">]</span> <span class="o">=</span>       <span class="s1">&#39;This is a test&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:content_disposition</span><span class="o">]</span> <span class="o">=</span>       <span class="s1">&#39;attachment; filename=File&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:content_id</span><span class="o">]</span> <span class="o">=</span>                <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:mime_version</span><span class="o">]=</span>  <span class="s1">&#39;1.0&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="ss">:body</span><span class="o">]</span> <span class="o">=</span>          <span class="s1">&#39;This is a body of text&#39;</span>

        <span class="n">message</span><span class="o">.</span><span class="n">bcc</span><span class="o">.</span><span class="n">should</span>           <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@bcc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">should</span>            <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@cc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="s1">&#39;this is a comment&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:01 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@from.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">in_reply_to</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="s1">&#39;1234@in_reply_to.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;of the new mail&quot;</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">message_id</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="s1">&#39;1234@message_id.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">received</span><span class="o">.</span><span class="n">date_time</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:02 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">references</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="s1">&#39;1234@references.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">reply_to</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@reply-to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_bcc</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-bcc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_cc</span><span class="o">.</span><span class="n">should</span>     <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-cc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_date</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:03 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_from</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-from.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_message_id</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;1234@resent_message_id.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_sender</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-sender.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_to</span><span class="o">.</span><span class="n">should</span>     <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">should</span>        <span class="n">eq</span> <span class="s1">&#39;mikel@sender.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;Hello there Mikel&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span>            <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">should</span>              <span class="n">eq</span> <span class="s1">&#39;text/plain; charset=UTF-8&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_transfer_encoding</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;7bit&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_description</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;This is a test&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_disposition</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;attachment; filename=File&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_id</span><span class="o">.</span><span class="n">should</span>                <span class="n">eq</span> <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">mime_version</span><span class="o">.</span><span class="n">should</span>              <span class="n">eq</span> <span class="s1">&#39;1.0&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="s1">&#39;This is a body of text&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should accept them in key, value form as strings&quot;</span> <span class="k">do</span>
        <span class="n">message</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;bcc&#39;</span><span class="o">]</span> <span class="o">=</span>           <span class="s1">&#39;mikel@bcc.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;cc&#39;</span><span class="o">]</span> <span class="o">=</span>            <span class="s1">&#39;mikel@cc.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;comments&#39;</span><span class="o">]</span> <span class="o">=</span>      <span class="s1">&#39;this is a comment&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;date&#39;</span><span class="o">]</span> <span class="o">=</span>          <span class="s1">&#39;12 Aug 2009 00:00:01 GMT&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;from&#39;</span><span class="o">]</span> <span class="o">=</span>          <span class="s1">&#39;mikel@from.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;in_reply_to&#39;</span><span class="o">]</span> <span class="o">=</span>   <span class="s1">&#39;&lt;1234@in_reply_to.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;keywords&#39;</span><span class="o">]</span> <span class="o">=</span>      <span class="s1">&#39;test, &quot;of the new mail&quot;, system&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;message_id&#39;</span><span class="o">]</span> <span class="o">=</span>    <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;received&#39;</span><span class="o">]</span> <span class="o">=</span>      <span class="s1">&#39;from machine.example by x.y.test; 12 Aug 2009 00:00:02 GMT&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;references&#39;</span><span class="o">]</span> <span class="o">=</span>    <span class="s1">&#39;&lt;1234@references.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;reply_to&#39;</span><span class="o">]</span> <span class="o">=</span>      <span class="s1">&#39;mikel@reply-to.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;resent_bcc&#39;</span><span class="o">]</span> <span class="o">=</span>    <span class="s1">&#39;mikel@resent-bcc.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;resent_cc&#39;</span><span class="o">]</span> <span class="o">=</span>     <span class="s1">&#39;mikel@resent-cc.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;resent_date&#39;</span><span class="o">]</span> <span class="o">=</span>   <span class="s1">&#39;12 Aug 2009 00:00:03 GMT&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;resent_from&#39;</span><span class="o">]</span> <span class="o">=</span>   <span class="s1">&#39;mikel@resent-from.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;resent_message_id&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;1234@resent_message_id.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;resent_sender&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;mikel@resent-sender.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;resent_to&#39;</span><span class="o">]</span> <span class="o">=</span>     <span class="s1">&#39;mikel@resent-to.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;sender&#39;</span><span class="o">]</span> <span class="o">=</span>        <span class="s1">&#39;mikel@sender.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;subject&#39;</span><span class="o">]</span> <span class="o">=</span>       <span class="s1">&#39;Hello there Mikel&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;to&#39;</span><span class="o">]</span> <span class="o">=</span>            <span class="s1">&#39;mikel@to.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;content_type&#39;</span><span class="o">]</span> <span class="o">=</span>  <span class="s1">&#39;text/plain; charset=UTF-8&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;content_transfer_encoding&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;7bit&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;content_description&#39;</span><span class="o">]</span> <span class="o">=</span>       <span class="s1">&#39;This is a test&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;content_disposition&#39;</span><span class="o">]</span> <span class="o">=</span>       <span class="s1">&#39;attachment; filename=File&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;content_id&#39;</span><span class="o">]</span> <span class="o">=</span>                <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;mime_version&#39;</span><span class="o">]</span> <span class="o">=</span>  <span class="s1">&#39;1.0&#39;</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;body&#39;</span><span class="o">]</span> <span class="o">=</span>          <span class="s1">&#39;This is a body of text&#39;</span>

        <span class="n">message</span><span class="o">.</span><span class="n">bcc</span><span class="o">.</span><span class="n">should</span>           <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@bcc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">should</span>            <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@cc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="s1">&#39;this is a comment&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:01 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@from.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">in_reply_to</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="s1">&#39;1234@in_reply_to.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;of the new mail&quot;</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">message_id</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="s1">&#39;1234@message_id.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">received</span><span class="o">.</span><span class="n">date_time</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:02 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">references</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="s1">&#39;1234@references.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">reply_to</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@reply-to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_bcc</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-bcc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_cc</span><span class="o">.</span><span class="n">should</span>     <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-cc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_date</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:03 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_from</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-from.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_message_id</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;1234@resent_message_id.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_sender</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-sender.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_to</span><span class="o">.</span><span class="n">should</span>     <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">should</span>        <span class="n">eq</span> <span class="s1">&#39;mikel@sender.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;Hello there Mikel&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span>            <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">should</span>              <span class="n">eq</span> <span class="s1">&#39;text/plain; charset=UTF-8&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_transfer_encoding</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;7bit&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_description</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;This is a test&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_disposition</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;attachment; filename=File&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_id</span><span class="o">.</span><span class="n">should</span>                <span class="n">eq</span> <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">mime_version</span><span class="o">.</span><span class="n">should</span>              <span class="n">eq</span> <span class="s1">&#39;1.0&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="s1">&#39;This is a body of text&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should accept them as a hash with symbols&quot;</span> <span class="k">do</span>
        <span class="n">message</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
          <span class="ss">:bcc</span> <span class="o">=&gt;</span>           <span class="s1">&#39;mikel@bcc.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="ss">:cc</span> <span class="o">=&gt;</span>            <span class="s1">&#39;mikel@cc.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="ss">:comments</span> <span class="o">=&gt;</span>      <span class="s1">&#39;this is a comment&#39;</span><span class="p">,</span>
          <span class="ss">:date</span> <span class="o">=&gt;</span>          <span class="s1">&#39;12 Aug 2009 00:00:01 GMT&#39;</span><span class="p">,</span>
          <span class="ss">:from</span> <span class="o">=&gt;</span>          <span class="s1">&#39;mikel@from.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="ss">:in_reply_to</span> <span class="o">=&gt;</span>   <span class="s1">&#39;&lt;1234@in_reply_to.lindsaar.net&gt;&#39;</span><span class="p">,</span>
          <span class="ss">:keywords</span> <span class="o">=&gt;</span>      <span class="s1">&#39;test, &quot;of the new mail&quot;, system&#39;</span><span class="p">,</span>
          <span class="ss">:message_id</span> <span class="o">=&gt;</span>    <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span><span class="p">,</span>
          <span class="ss">:received</span> <span class="o">=&gt;</span>      <span class="s1">&#39;from machine.example by x.y.test; 12 Aug 2009 00:00:02 GMT&#39;</span><span class="p">,</span>
          <span class="ss">:references</span> <span class="o">=&gt;</span>    <span class="s1">&#39;&lt;1234@references.lindsaar.net&gt;&#39;</span><span class="p">,</span>
          <span class="ss">:reply_to</span> <span class="o">=&gt;</span>      <span class="s1">&#39;mikel@reply-to.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="ss">:resent_bcc</span> <span class="o">=&gt;</span>    <span class="s1">&#39;mikel@resent-bcc.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="ss">:resent_cc</span> <span class="o">=&gt;</span>     <span class="s1">&#39;mikel@resent-cc.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="ss">:resent_date</span> <span class="o">=&gt;</span>   <span class="s1">&#39;12 Aug 2009 00:00:03 GMT&#39;</span><span class="p">,</span>
          <span class="ss">:resent_from</span> <span class="o">=&gt;</span>   <span class="s1">&#39;mikel@resent-from.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="ss">:resent_message_id</span> <span class="o">=&gt;</span> <span class="s1">&#39;&lt;1234@resent_message_id.lindsaar.net&gt;&#39;</span><span class="p">,</span>
          <span class="ss">:resent_sender</span> <span class="o">=&gt;</span> <span class="s1">&#39;mikel@resent-sender.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="ss">:resent_to</span> <span class="o">=&gt;</span>     <span class="s1">&#39;mikel@resent-to.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="ss">:sender</span> <span class="o">=&gt;</span>        <span class="s1">&#39;mikel@sender.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="ss">:subject</span> <span class="o">=&gt;</span>       <span class="s1">&#39;Hello there Mikel&#39;</span><span class="p">,</span>
          <span class="ss">:to</span> <span class="o">=&gt;</span>            <span class="s1">&#39;mikel@to.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="ss">:content_type</span> <span class="o">=&gt;</span>  <span class="s1">&#39;text/plain; charset=UTF-8&#39;</span><span class="p">,</span>
          <span class="ss">:content_transfer_encoding</span> <span class="o">=&gt;</span> <span class="s1">&#39;7bit&#39;</span><span class="p">,</span>
          <span class="ss">:content_description</span> <span class="o">=&gt;</span>       <span class="s1">&#39;This is a test&#39;</span><span class="p">,</span>
          <span class="ss">:content_disposition</span> <span class="o">=&gt;</span>       <span class="s1">&#39;attachment; filename=File&#39;</span><span class="p">,</span>
          <span class="ss">:content_id</span> <span class="o">=&gt;</span>                <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span><span class="p">,</span>
          <span class="ss">:mime_version</span> <span class="o">=&gt;</span>  <span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
          <span class="ss">:body</span> <span class="o">=&gt;</span>          <span class="s1">&#39;This is a body of text&#39;</span>
        <span class="p">})</span>

        <span class="n">message</span><span class="o">.</span><span class="n">bcc</span><span class="o">.</span><span class="n">should</span>           <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@bcc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">should</span>            <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@cc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="s1">&#39;this is a comment&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:01 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@from.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">in_reply_to</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="s1">&#39;1234@in_reply_to.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;of the new mail&quot;</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">message_id</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="s1">&#39;1234@message_id.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">received</span><span class="o">.</span><span class="n">date_time</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:02 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">references</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="s1">&#39;1234@references.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">reply_to</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@reply-to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_bcc</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-bcc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_cc</span><span class="o">.</span><span class="n">should</span>     <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-cc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_date</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:03 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_from</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-from.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_message_id</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;1234@resent_message_id.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_sender</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-sender.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_to</span><span class="o">.</span><span class="n">should</span>     <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">should</span>        <span class="n">eq</span> <span class="s1">&#39;mikel@sender.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;Hello there Mikel&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span>            <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">should</span>              <span class="n">eq</span> <span class="s1">&#39;text/plain; charset=UTF-8&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_transfer_encoding</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;7bit&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_description</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;This is a test&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_disposition</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;attachment; filename=File&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_id</span><span class="o">.</span><span class="n">should</span>                <span class="n">eq</span> <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">mime_version</span><span class="o">.</span><span class="n">should</span>              <span class="n">eq</span> <span class="s1">&#39;1.0&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="s1">&#39;This is a body of text&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should accept them as a hash with strings&quot;</span> <span class="k">do</span>
        <span class="n">message</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
          <span class="s1">&#39;bcc&#39;</span> <span class="o">=&gt;</span>           <span class="s1">&#39;mikel@bcc.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="s1">&#39;cc&#39;</span> <span class="o">=&gt;</span>            <span class="s1">&#39;mikel@cc.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="s1">&#39;comments&#39;</span> <span class="o">=&gt;</span>      <span class="s1">&#39;this is a comment&#39;</span><span class="p">,</span>
          <span class="s1">&#39;date&#39;</span> <span class="o">=&gt;</span>          <span class="s1">&#39;12 Aug 2009 00:00:01 GMT&#39;</span><span class="p">,</span>
          <span class="s1">&#39;from&#39;</span> <span class="o">=&gt;</span>          <span class="s1">&#39;mikel@from.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="s1">&#39;in_reply_to&#39;</span> <span class="o">=&gt;</span>   <span class="s1">&#39;&lt;1234@in_reply_to.lindsaar.net&gt;&#39;</span><span class="p">,</span>
          <span class="s1">&#39;keywords&#39;</span> <span class="o">=&gt;</span>      <span class="s1">&#39;test, &quot;of the new mail&quot;, system&#39;</span><span class="p">,</span>
          <span class="s1">&#39;message_id&#39;</span> <span class="o">=&gt;</span>    <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span><span class="p">,</span>
          <span class="s1">&#39;received&#39;</span> <span class="o">=&gt;</span>      <span class="s1">&#39;from machine.example by x.y.test; 12 Aug 2009 00:00:02 GMT&#39;</span><span class="p">,</span>
          <span class="s1">&#39;references&#39;</span> <span class="o">=&gt;</span>    <span class="s1">&#39;&lt;1234@references.lindsaar.net&gt;&#39;</span><span class="p">,</span>
          <span class="s1">&#39;reply_to&#39;</span> <span class="o">=&gt;</span>      <span class="s1">&#39;mikel@reply-to.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="s1">&#39;resent_bcc&#39;</span> <span class="o">=&gt;</span>    <span class="s1">&#39;mikel@resent-bcc.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="s1">&#39;resent_cc&#39;</span> <span class="o">=&gt;</span>     <span class="s1">&#39;mikel@resent-cc.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="s1">&#39;resent_date&#39;</span> <span class="o">=&gt;</span>   <span class="s1">&#39;12 Aug 2009 00:00:03 GMT&#39;</span><span class="p">,</span>
          <span class="s1">&#39;resent_from&#39;</span> <span class="o">=&gt;</span>   <span class="s1">&#39;mikel@resent-from.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="s1">&#39;resent_message_id&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&lt;1234@resent_message_id.lindsaar.net&gt;&#39;</span><span class="p">,</span>
          <span class="s1">&#39;resent_sender&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;mikel@resent-sender.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="s1">&#39;resent_to&#39;</span> <span class="o">=&gt;</span>     <span class="s1">&#39;mikel@resent-to.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="s1">&#39;sender&#39;</span> <span class="o">=&gt;</span>        <span class="s1">&#39;mikel@sender.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="s1">&#39;subject&#39;</span> <span class="o">=&gt;</span>       <span class="s1">&#39;Hello there Mikel&#39;</span><span class="p">,</span>
          <span class="s1">&#39;to&#39;</span> <span class="o">=&gt;</span>            <span class="s1">&#39;mikel@to.lindsaar.net&#39;</span><span class="p">,</span>
          <span class="s1">&#39;content_type&#39;</span> <span class="o">=&gt;</span>  <span class="s1">&#39;text/plain; charset=UTF-8&#39;</span><span class="p">,</span>
          <span class="s1">&#39;content_transfer_encoding&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;7bit&#39;</span><span class="p">,</span>
          <span class="s1">&#39;content_description&#39;</span> <span class="o">=&gt;</span>       <span class="s1">&#39;This is a test&#39;</span><span class="p">,</span>
          <span class="s1">&#39;content_disposition&#39;</span> <span class="o">=&gt;</span>       <span class="s1">&#39;attachment; filename=File&#39;</span><span class="p">,</span>
          <span class="s1">&#39;content_id&#39;</span> <span class="o">=&gt;</span>                <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span><span class="p">,</span>
          <span class="s1">&#39;mime_version&#39;</span> <span class="o">=&gt;</span>  <span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
          <span class="s1">&#39;body&#39;</span> <span class="o">=&gt;</span>          <span class="s1">&#39;This is a body of text&#39;</span>
        <span class="p">})</span>

        <span class="n">message</span><span class="o">.</span><span class="n">bcc</span><span class="o">.</span><span class="n">should</span>           <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@bcc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">should</span>            <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@cc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="s1">&#39;this is a comment&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:01 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@from.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">in_reply_to</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="s1">&#39;1234@in_reply_to.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="o">[</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;of the new mail&quot;</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">message_id</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="s1">&#39;1234@message_id.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">received</span><span class="o">.</span><span class="n">date_time</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:02 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">references</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="s1">&#39;1234@references.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">reply_to</span><span class="o">.</span><span class="n">should</span>      <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@reply-to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_bcc</span><span class="o">.</span><span class="n">should</span>    <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-bcc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_cc</span><span class="o">.</span><span class="n">should</span>     <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-cc.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_date</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;12 Aug 2009 00:00:03 GMT&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_from</span><span class="o">.</span><span class="n">should</span>   <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-from.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_message_id</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;1234@resent_message_id.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_sender</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-sender.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">resent_to</span><span class="o">.</span><span class="n">should</span>     <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@resent-to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">should</span>        <span class="n">eq</span> <span class="s1">&#39;mikel@sender.lindsaar.net&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;Hello there Mikel&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span>            <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;mikel@to.lindsaar.net&#39;</span><span class="o">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">should</span>              <span class="n">eq</span> <span class="s1">&#39;text/plain; charset=UTF-8&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_transfer_encoding</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;7bit&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_description</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;This is a test&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_disposition</span><span class="o">.</span><span class="n">should</span>       <span class="n">eq</span> <span class="s1">&#39;attachment; filename=File&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">content_id</span><span class="o">.</span><span class="n">should</span>                <span class="n">eq</span> <span class="s1">&#39;&lt;1234@message_id.lindsaar.net&gt;&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">mime_version</span><span class="o">.</span><span class="n">should</span>              <span class="n">eq</span> <span class="s1">&#39;1.0&#39;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span>          <span class="n">eq</span> <span class="s1">&#39;This is a body of text&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should let you set custom headers with a :headers =&gt; {hash}&quot;</span> <span class="k">do</span>
        <span class="n">message</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:headers</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;custom-header&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;mikel&#39;</span><span class="p">})</span>
        <span class="n">message</span><span class="o">[</span><span class="s1">&#39;custom-header&#39;</span><span class="o">].</span><span class="n">decoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;mikel&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should assign the body to a part on creation&quot;</span> <span class="k">do</span>
        <span class="n">message</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
          <span class="n">part</span><span class="p">({</span><span class="ss">:content_type</span><span class="o">=&gt;</span><span class="s2">&quot;multipart/alternative&quot;</span><span class="p">,</span> <span class="ss">:content_disposition</span><span class="o">=&gt;</span><span class="s2">&quot;inline&quot;</span><span class="p">,</span> <span class="ss">:body</span><span class="o">=&gt;</span><span class="s2">&quot;Nothing to see here.&quot;</span><span class="p">})</span>
        <span class="k">end</span>
        <span class="n">message</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;Nothing to see here.&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should not overwrite bodies on creation&quot;</span> <span class="k">do</span>
        <span class="n">message</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
          <span class="n">part</span><span class="p">({</span><span class="ss">:content_type</span><span class="o">=&gt;</span><span class="s2">&quot;multipart/alternative&quot;</span><span class="p">,</span> <span class="ss">:content_disposition</span><span class="o">=&gt;</span><span class="s2">&quot;inline&quot;</span><span class="p">,</span> <span class="ss">:body</span><span class="o">=&gt;</span><span class="s2">&quot;Nothing to see here.&quot;</span><span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
            <span class="nb">p</span><span class="o">.</span><span class="n">part</span> <span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">,</span> <span class="ss">:body</span> <span class="o">=&gt;</span> <span class="s2">&quot;&lt;b&gt;test&lt;/b&gt; HTML&lt;br/&gt;&quot;</span>
          <span class="k">end</span>
        <span class="k">end</span>
        <span class="n">message</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">body</span><span class="o">.</span><span class="n">decoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;Nothing to see here.&quot;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">body</span><span class="o">.</span><span class="n">decoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;&lt;b&gt;test&lt;/b&gt; HTML&lt;br/&gt;&quot;</span>
        <span class="n">message</span><span class="o">.</span><span class="n">encoded</span><span class="o">.</span><span class="n">should</span> <span class="n">match</span> <span class="sr">%r{Nothing to see here\.}</span>
        <span class="n">message</span><span class="o">.</span><span class="n">encoded</span><span class="o">.</span><span class="n">should</span> <span class="n">match</span> <span class="sr">%r{&lt;b&gt;test&lt;/b&gt; HTML&lt;br/&gt;}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should allow you to init on an array of addresses from a hash&quot;</span> <span class="k">do</span>
        <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:to</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;test1@lindsaar.net&#39;</span><span class="p">,</span> <span class="s1">&#39;Mikel &lt;test2@lindsaar.net&gt;&#39;</span><span class="o">]</span><span class="p">)</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;test1@lindsaar.net&#39;</span><span class="p">,</span> <span class="s1">&#39;test2@lindsaar.net&#39;</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should allow you to init on an array of addresses directly&quot;</span> <span class="k">do</span>
        <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;test1@lindsaar.net&#39;</span><span class="p">,</span> <span class="s1">&#39;Mikel &lt;test2@lindsaar.net&gt;&#39;</span><span class="o">]</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;test1@lindsaar.net&#39;</span><span class="p">,</span> <span class="s1">&#39;test2@lindsaar.net&#39;</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should allow you to init on an array of addresses directly&quot;</span> <span class="k">do</span>
        <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
        <span class="n">mail</span><span class="o">[</span><span class="ss">:to</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;test1@lindsaar.net&#39;</span><span class="p">,</span> <span class="s1">&#39;Mikel &lt;test2@lindsaar.net&gt;&#39;</span><span class="o">]</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;test1@lindsaar.net&#39;</span><span class="p">,</span> <span class="s1">&#39;test2@lindsaar.net&#39;</span><span class="o">]</span>
      <span class="k">end</span>

    <span class="k">end</span>

  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;handling missing required fields:&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;every email&quot;</span> <span class="k">do</span>

      <span class="n">describe</span> <span class="s2">&quot;Message-ID&quot;</span> <span class="k">do</span>
        <span class="n">it</span> <span class="s2">&quot;should say if it has a message id&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
               <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
                 <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
            <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
               <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
          <span class="k">end</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_has_message_id</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should preserve any message id that you pass it if add_message_id is called explicitly&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
               <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
                 <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
            <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
               <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
          <span class="k">end</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">add_message_id</span><span class="p">(</span><span class="s2">&quot;&lt;ThisIsANonUniqueMessageId@me.com&gt;&quot;</span><span class="p">)</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/Message-ID: &lt;ThisIsANonUniqueMessageId@me.com&gt;\r\n/</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should generate a random message ID if nothing is passed to add_message_id&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
               <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
                 <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
            <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
               <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
          <span class="k">end</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">add_message_id</span>
          <span class="n">fqdn</span> <span class="o">||=</span> <span class="o">::</span><span class="no">Socket</span><span class="o">.</span><span class="n">gethostname</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/Message-ID: &lt;[\w]+@</span><span class="si">#{</span><span class="n">fqdn</span><span class="si">}</span><span class="sr">.mail&gt;\r\n/</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should make an email and inject a message ID if none was set if told to_s&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
               <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
                 <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
            <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
               <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
          <span class="k">end</span>
          <span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">/Message-ID: &lt;.+@.+.mail&gt;/i</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_nil</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should add the message id to the message permanently once sent to_s&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
               <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
                 <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
            <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
               <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
          <span class="k">end</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">should</span> <span class="n">be_has_message_id</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should add a body part if it is missing&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Body</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;Date&quot;</span> <span class="k">do</span>
        <span class="n">it</span> <span class="s2">&quot;should say if it has a date&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
               <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
                 <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
            <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
               <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
          <span class="k">end</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_has_date</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should preserve any date that you pass it if add_date is called explicitly&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
               <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
                 <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
            <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
               <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
          <span class="k">end</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">add_date</span><span class="p">(</span><span class="s2">&quot;Mon, 24 Nov 1997 14:22:01 -0800&quot;</span><span class="p">)</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/Date: Mon, 24 Nov 1997 14:22:01 -0800/</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should generate a current date if nothing is passed to add_date&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
               <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
                 <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
            <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
               <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
          <span class="k">end</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">add_date</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/Date: \w{3}, [\s\d]\d \w{3} \d{4} \d{2}:\d{2}:\d{2} [-+]?\d{4}\r\n/</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should make an email and inject a date if none was set if told to_s&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
               <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
                 <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
            <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
               <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
          <span class="k">end</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/Date: \w{3}, [\s\d]\d \w{3} \d{4} \d{2}:\d{2}:\d{2} [-+]?\d{4}\r\n/</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should add the date to the message permanently once sent to_s&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
               <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
                 <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
            <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
               <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
          <span class="k">end</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">should</span> <span class="n">be_has_date</span>
        <span class="k">end</span>
      <span class="k">end</span>

    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;mime emails&quot;</span> <span class="k">do</span>

      <span class="n">describe</span> <span class="s2">&quot;mime-version&quot;</span> <span class="k">do</span>
        <span class="n">it</span> <span class="s2">&quot;should say if it has a mime-version&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
               <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
                 <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
            <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
               <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
          <span class="k">end</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_has_mime_version</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should preserve any mime version that you pass it if add_mime_version is called explicitly&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
               <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
                 <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
            <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
               <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
          <span class="k">end</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">add_mime_version</span><span class="p">(</span><span class="s2">&quot;3.0 (This is an unreal version number)&quot;</span><span class="p">)</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/Mime-Version: 3.0\r\n/</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should generate a mime version if nothing is passed to add_date&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
               <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
                 <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
            <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
               <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
          <span class="k">end</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">add_mime_version</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/Mime-Version: 1.0\r\n/</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should make an email and inject a mime_version if none was set if told to_s&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
               <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
                 <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
            <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
               <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
          <span class="k">end</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/Mime-Version: 1.0\r\n/</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should add the mime version to the message permanently once sent to_s&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
               <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
                 <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
            <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
               <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
          <span class="k">end</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">should</span> <span class="n">be_has_mime_version</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;content type&quot;</span> <span class="k">do</span>

        <span class="n">it</span> <span class="s2">&quot;should say if it has a content type&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;Content-Type: text/plain&#39;</span><span class="p">)</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">should</span> <span class="n">be_has_content_type</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should say if it does not have a content type&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_has_content_type</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should say if it has a charset&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;Content-Type: text/plain; charset=US-ASCII&#39;</span><span class="p">)</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">should</span> <span class="n">be_has_charset</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should say if it has a charset&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;Content-Type: text/plain&#39;</span><span class="p">)</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_has_charset</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should not raise a warning if there is no charset defined and only US-ASCII chars&quot;</span> <span class="k">do</span>
          <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;This is plain text US-ASCII&quot;</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
          <span class="no">STDERR</span><span class="o">.</span><span class="n">should_not_receive</span><span class="p">(</span><span class="ss">:puts</span><span class="p">)</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should set the content type to text/plain; charset=us-ascii&quot;</span> <span class="k">do</span>
          <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;This is plain text US-ASCII&quot;</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">%r{Content-Type: text/plain; charset=US-ASCII}</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should not set the charset if the file is an attachment&quot;</span> <span class="k">do</span>
          <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;This is plain text US-ASCII&quot;</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">content_disposition</span> <span class="o">=</span> <span class="s1">&#39;attachment; filename=&quot;foo.jpg&quot;&#39;</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">%r{Content-Type: text/plain;\r\n}</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should raise a warning if there is no content type and there is non ascii chars and default to text/plain, UTF-8&quot;</span> <span class="k">do</span>
          <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;This is NOT plain text ASCII　− かきくけこ&quot;</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">content_transfer_encoding</span> <span class="o">=</span> <span class="s2">&quot;8bit&quot;</span>
          <span class="no">STDERR</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:puts</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="sr">/Non US-ASCII detected and no charset defined.\nDefaulting to UTF-8, set your own if this is incorrect./m</span><span class="p">)</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">%r{Content-Type: text/plain; charset=UTF-8}</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should raise a warning if there is no charset parameter and there is non ascii chars and default to text/plain, UTF-8&quot;</span> <span class="k">do</span>
          <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;This is NOT plain text ASCII　− かきくけこ&quot;</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s2">&quot;text/plain&quot;</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">content_transfer_encoding</span> <span class="o">=</span> <span class="s2">&quot;8bit&quot;</span>
          <span class="no">STDERR</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:puts</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="sr">/Non US-ASCII detected and no charset defined.\nDefaulting to UTF-8, set your own if this is incorrect./m</span><span class="p">)</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">%r{Content-Type: text/plain; charset=UTF-8}</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should not raise a warning if there is a charset defined and there is non ascii chars&quot;</span> <span class="k">do</span>
          <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;This is NOT plain text ASCII　− かきくけこ&quot;</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">content_transfer_encoding</span> <span class="o">=</span> <span class="s2">&quot;8bit&quot;</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s2">&quot;text/plain; charset=UTF-8&quot;</span>
          <span class="no">STDERR</span><span class="o">.</span><span class="n">should_not_receive</span><span class="p">(</span><span class="ss">:puts</span><span class="p">)</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should be able to set a content type with an array and hash&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;plain&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:charset</span> <span class="o">=&gt;</span> <span class="s1">&#39;US-ASCII&#39;</span> <span class="p">}</span><span class="o">]</span>
          <span class="n">mail</span><span class="o">[</span><span class="ss">:content_type</span><span class="o">].</span><span class="n">encoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="sx">%Q[Content-Type: text/plain;</span><span class="se">\r\n\s</span><span class="sx">charset=US-ASCII</span><span class="se">\r\n</span><span class="sx">]</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">content_type_parameters</span><span class="o">.</span><span class="n">should</span> <span class="n">eql</span><span class="p">({</span><span class="s2">&quot;charset&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;US-ASCII&quot;</span><span class="p">})</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should be able to set a content type with an array and hash with a non-usascii field&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;plain&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:charset</span> <span class="o">=&gt;</span> <span class="s1">&#39;UTF-8&#39;</span> <span class="p">}</span><span class="o">]</span>
          <span class="n">mail</span><span class="o">[</span><span class="ss">:content_type</span><span class="o">].</span><span class="n">encoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="sx">%Q[Content-Type: text/plain;</span><span class="se">\r\n\s</span><span class="sx">charset=UTF-8</span><span class="se">\r\n</span><span class="sx">]</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">content_type_parameters</span><span class="o">.</span><span class="n">should</span> <span class="n">eql</span><span class="p">({</span><span class="s2">&quot;charset&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">})</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should allow us to specify a content type in a block&quot;</span> <span class="k">do</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="n">content_type</span> <span class="o">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;plain&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;charset&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;UTF-8&quot;</span> <span class="p">}</span><span class="o">]</span> <span class="p">}</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">content_type_parameters</span><span class="o">.</span><span class="n">should</span> <span class="n">eql</span><span class="p">({</span><span class="s2">&quot;charset&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">})</span>
        <span class="k">end</span>

      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;content-transfer-encoding&quot;</span> <span class="k">do</span>

        <span class="n">it</span> <span class="s2">&quot;should use 7bit for only US-ASCII chars&quot;</span> <span class="k">do</span>
          <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;This is plain text US-ASCII&quot;</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">%r{Content-Transfer-Encoding: 7bit}</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should use QP transfer encoding for 8bit text with only a few 8bit characters&quot;</span> <span class="k">do</span>
          <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;Maxfeldstraße 5, 90409 Nürnberg&quot;</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">charset</span> <span class="o">=</span> <span class="s2">&quot;UTF-8&quot;</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">%r{Content-Transfer-Encoding: quoted-printable}</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should use base64 transfer encoding for 8-bit text with lots of 8bit characters&quot;</span> <span class="k">do</span>
          <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;This is NOT plain text ASCII　− かきくけこ&quot;</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">charset</span> <span class="o">=</span> <span class="s2">&quot;UTF-8&quot;</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s2">&quot;text/plain; charset=utf-8&quot;</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">should</span> <span class="n">be_has_content_type</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">should</span> <span class="n">be_has_charset</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span>  <span class="sr">%r{Content-Transfer-Encoding: base64}</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should not use 8bit transfer encoding when 8bit is allowed&quot;</span> <span class="k">do</span>
          <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;This is NOT plain text ASCII　− かきくけこ&quot;</span>
          <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">charset</span> <span class="o">=</span> <span class="s2">&quot;UTF-8&quot;</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s2">&quot;text/plain; charset=utf-8&quot;</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">transport_encoding</span> <span class="o">=</span> <span class="s2">&quot;8bit&quot;</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">%r{Content-Transfer-Encoding: 8bit}</span>
        <span class="k">end</span>

      <span class="k">end</span>

    <span class="k">end</span>

  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;output&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should make an email and allow you to call :to_s on it to get a string&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
           <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
             <span class="n">to</span> <span class="s1">&#39;you@test.lindsaar.net&#39;</span>
        <span class="n">subject</span> <span class="s1">&#39;This is a test email&#39;</span>
           <span class="n">body</span> <span class="s1">&#39;This is a body of the email&#39;</span>
      <span class="k">end</span>

      <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/From: mikel@test.lindsaar.net\r\n/</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/To: you@test.lindsaar.net\r\n/</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/Subject: This is a test email\r\n/</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/This is a body of the email/</span>

    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should raise an error and message if you try and call decoded on a multipart email&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
        <span class="n">to</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
        <span class="n">from</span> <span class="s1">&#39;bob@test.lindsaar.net&#39;</span>
        <span class="n">subject</span> <span class="s1">&#39;Multipart email&#39;</span>
        <span class="n">text_part</span> <span class="k">do</span>
          <span class="n">body</span> <span class="s1">&#39;This is plain text&#39;</span>
        <span class="k">end</span>
        <span class="n">html_part</span> <span class="k">do</span>
          <span class="n">content_type</span> <span class="s1">&#39;text/html; charset=UTF-8&#39;</span>
          <span class="n">body</span> <span class="s1">&#39;&lt;h1&gt;This is HTML&lt;/h1&gt;&#39;</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="n">doing</span> <span class="p">{</span> <span class="n">mail</span><span class="o">.</span><span class="n">decoded</span> <span class="p">}</span><span class="o">.</span><span class="n">should</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">NoMethodError</span><span class="p">,</span> <span class="s1">&#39;Can not decode an entire message, try calling #decoded on the various fields and body or parts if it is a multipart message.&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should return the decoded body if you call decode and the message is not multipart&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
        <span class="n">content_transfer_encoding</span> <span class="s1">&#39;base64&#39;</span>
        <span class="n">body</span> <span class="s2">&quot;VGhlIGJvZHk=</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="k">end</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">decoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;The body&quot;</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;decoding bodies&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should not change a body on decode if not given an encoding type to decode&quot;</span> <span class="k">do</span>
        <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
          <span class="n">body</span> <span class="s2">&quot;The=3Dbody&quot;</span>
        <span class="k">end</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;The=3Dbody&quot;</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;The=3Dbody&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should change a body on decode if given an encoding type to decode&quot;</span> <span class="k">do</span>
        <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
          <span class="n">content_transfer_encoding</span> <span class="s1">&#39;quoted-printable&#39;</span>
          <span class="n">body</span> <span class="s2">&quot;The=3Dbody&quot;</span>
        <span class="k">end</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;The=body&quot;</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;The=3Dbody=</span><span class="se">\r\n</span><span class="s2">&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should change a body on decode if given an encoding type to decode&quot;</span> <span class="k">do</span>
        <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
          <span class="n">content_transfer_encoding</span> <span class="s1">&#39;base64&#39;</span>
          <span class="n">body</span> <span class="s2">&quot;VGhlIGJvZHk=</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">end</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;The body&quot;</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;VGhlIGJvZHk=</span><span class="se">\r\n</span><span class="s2">&quot;</span>
      <span class="k">end</span>

    <span class="k">end</span>

  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;text messages&quot;</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">message_with_iso_8859_1_charset</span>
      <span class="s2">&quot;From: test@example.com</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="o">+</span>
      <span class="s2">&quot;Content-Type: text/plain; charset=iso-8859-1</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="o">+</span>
      <span class="s2">&quot;Content-Transfer-Encoding: quoted-printable</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="o">+</span>
      <span class="s2">&quot;Date: Tue, 27 Sep 2011 16:59:48 +0100 (BST)</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="o">+</span>
      <span class="s2">&quot;Subject: test</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="o">+</span>
      <span class="s2">&quot;Am=E9rica&quot;</span>
    <span class="k">end</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@message</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">message_with_iso_8859_1_charset</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should be decoded using content type charset&quot;</span> <span class="k">do</span>
      <span class="vi">@message</span><span class="o">.</span><span class="n">decoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;América&quot;</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should respond true to text?&quot;</span> <span class="k">do</span>
      <span class="vi">@message</span><span class="o">.</span><span class="n">text?</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="kp">true</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;helper methods&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;==&quot;</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Ensure specs don't randomly fail due to messages being generated 1 second apart</p></td><td class="code"><div class="highlight"><pre>        <span class="n">time</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
        <span class="no">DateTime</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:now</span><span class="p">)</span><span class="o">.</span><span class="n">twice</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should be implemented&quot;</span> <span class="k">do</span>
        <span class="n">doing</span> <span class="p">{</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="o">==</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="p">}</span><span class="o">.</span><span class="n">should_not</span> <span class="n">raise_error</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should ignore the message id value if both have a nil message id&quot;</span> <span class="k">do</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel@test.lindsaar.net</span><span class="se">\r\n</span><span class="s2">Subject: Yo!</span><span class="se">\r\n\r\n</span><span class="s2">Hello there&quot;</span><span class="p">)</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel@test.lindsaar.net</span><span class="se">\r\n</span><span class="s2">Subject: Yo!</span><span class="se">\r\n\r\n</span><span class="s2">Hello there&quot;</span><span class="p">)</span>
        <span class="n">m1</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="n">m2</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should ignore the message id value if self has a nil message id&quot;</span> <span class="k">do</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel@test.lindsaar.net</span><span class="se">\r\n</span><span class="s2">Subject: Yo!</span><span class="se">\r\n\r\n</span><span class="s2">Hello there&quot;</span><span class="p">)</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel@test.lindsaar.net</span><span class="se">\r\n</span><span class="s2">Message-ID: &lt;1234@test.lindsaar.net&gt;</span><span class="se">\r\n</span><span class="s2">Subject: Yo!</span><span class="se">\r\n\r\n</span><span class="s2">Hello there&quot;</span><span class="p">)</span>
        <span class="n">m1</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="n">m2</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should ignore the message id value if other has a nil message id&quot;</span> <span class="k">do</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel@test.lindsaar.net</span><span class="se">\r\n</span><span class="s2">Message-ID: &lt;1234@test.lindsaar.net&gt;</span><span class="se">\r\n</span><span class="s2">Subject: Yo!</span><span class="se">\r\n\r\n</span><span class="s2">Hello there&quot;</span><span class="p">)</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel@test.lindsaar.net</span><span class="se">\r\n</span><span class="s2">Subject: Yo!</span><span class="se">\r\n\r\n</span><span class="s2">Hello there&quot;</span><span class="p">)</span>
        <span class="n">m1</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="n">m2</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should not be == if both emails have different Message IDs&quot;</span> <span class="k">do</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel@test.lindsaar.net</span><span class="se">\r\n</span><span class="s2">Message-ID: &lt;4321@test.lindsaar.net&gt;</span><span class="se">\r\n</span><span class="s2">Subject: Yo!</span><span class="se">\r\n\r\n</span><span class="s2">Hello there&quot;</span><span class="p">)</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel@test.lindsaar.net</span><span class="se">\r\n</span><span class="s2">Message-ID: &lt;1234@test.lindsaar.net&gt;</span><span class="se">\r\n</span><span class="s2">Subject: Yo!</span><span class="se">\r\n\r\n</span><span class="s2">Hello there&quot;</span><span class="p">)</span>
        <span class="n">m1</span><span class="o">.</span><span class="n">should_not</span> <span class="n">eq</span> <span class="n">m2</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should preserve the message id of self if set&quot;</span> <span class="k">do</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel@test.lindsaar.net</span><span class="se">\r\n</span><span class="s2">Message-ID: &lt;1234@test.lindsaar.net&gt;</span><span class="se">\r\n</span><span class="s2">Subject: Yo!</span><span class="se">\r\n\r\n</span><span class="s2">Hello there&quot;</span><span class="p">)</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel@test.lindsaar.net</span><span class="se">\r\n</span><span class="s2">Subject: Yo!</span><span class="se">\r\n\r\n</span><span class="s2">Hello there&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">m1</span> <span class="o">==</span> <span class="n">m2</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span> <span class="c1"># confirm the side-effects of the comparison</span>
        <span class="n">m1</span><span class="o">.</span><span class="n">message_id</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;1234@test.lindsaar.net&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should preserve the message id of other if set&quot;</span> <span class="k">do</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel@test.lindsaar.net</span><span class="se">\r\n</span><span class="s2">Subject: Yo!</span><span class="se">\r\n\r\n</span><span class="s2">Hello there&quot;</span><span class="p">)</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel@test.lindsaar.net</span><span class="se">\r\n</span><span class="s2">Message-ID: &lt;1234@test.lindsaar.net&gt;</span><span class="se">\r\n</span><span class="s2">Subject: Yo!</span><span class="se">\r\n\r\n</span><span class="s2">Hello there&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">m1</span> <span class="o">==</span> <span class="n">m2</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span> <span class="c1"># confirm the side-effects of the comparison</span>
        <span class="n">m2</span><span class="o">.</span><span class="n">message_id</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;1234@test.lindsaar.net&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should preserve the message id of both if set&quot;</span> <span class="k">do</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel@test.lindsaar.net</span><span class="se">\r\n</span><span class="s2">Message-ID: &lt;4321@test.lindsaar.net&gt;</span><span class="se">\r\n</span><span class="s2">Subject: Yo!</span><span class="se">\r\n\r\n</span><span class="s2">Hello there&quot;</span><span class="p">)</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;To: mikel@test.lindsaar.net</span><span class="se">\r\n</span><span class="s2">Message-ID: &lt;1234@test.lindsaar.net&gt;</span><span class="se">\r\n</span><span class="s2">Subject: Yo!</span><span class="se">\r\n\r\n</span><span class="s2">Hello there&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">m1</span> <span class="o">==</span> <span class="n">m2</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span> <span class="c1"># confirm the side-effects of the comparison</span>
        <span class="n">m1</span><span class="o">.</span><span class="n">message_id</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;4321@test.lindsaar.net&#39;</span>
        <span class="n">m2</span><span class="o">.</span><span class="n">message_id</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;1234@test.lindsaar.net&#39;</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should implement the spaceship operator on the date field&quot;</span> <span class="k">do</span>
      <span class="n">now</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
      <span class="n">mail1</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
        <span class="n">date</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="n">mail2</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
        <span class="n">date</span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="c1"># Make mail2 10 seconds &#39;older&#39;</span>
      <span class="k">end</span>
      <span class="o">[</span><span class="n">mail2</span><span class="p">,</span> <span class="n">mail1</span><span class="o">].</span><span class="n">sort</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="n">mail2</span><span class="p">,</span> <span class="n">mail1</span><span class="o">]</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have a destinations method&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
        <span class="n">to</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
        <span class="n">cc</span> <span class="s1">&#39;bob@test.lindsaar.net&#39;</span>
        <span class="n">bcc</span> <span class="s1">&#39;sam@test.lindsaar.net&#39;</span>
      <span class="k">end</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">destinations</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">3</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have a from_addrs method&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
        <span class="n">from</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
      <span class="k">end</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">from_addrs</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">1</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have a from_addrs method that is empty if nil&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
      <span class="k">end</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">from_addrs</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">0</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have a to_addrs method&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
        <span class="n">to</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
      <span class="k">end</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">to_addrs</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">1</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have a to_addrs method that is empty if nil&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
      <span class="k">end</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">to_addrs</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">0</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have a cc_addrs method&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
        <span class="n">cc</span> <span class="s1">&#39;bob@test.lindsaar.net&#39;</span>
      <span class="k">end</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">cc_addrs</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">1</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have a cc_addrs method that is empty if nil&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
      <span class="k">end</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">cc_addrs</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">0</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have a bcc_addrs method&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
        <span class="n">bcc</span> <span class="s1">&#39;sam@test.lindsaar.net&#39;</span>
      <span class="k">end</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">bcc_addrs</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">1</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have a bcc_addrs method that is empty if nil&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
      <span class="k">end</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">bcc_addrs</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">0</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should give destinations even if some of the fields are blank&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
        <span class="n">to</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
      <span class="k">end</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">destinations</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">1</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should be able to encode with only one destination&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
        <span class="n">to</span> <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
      <span class="k">end</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">encoded</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;nested parts&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should provide a way to instantiate a new part as you go down&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
        <span class="n">to</span>           <span class="s1">&#39;mikel@test.lindsaar.net&#39;</span>
        <span class="n">subject</span>      <span class="s2">&quot;nested multipart&quot;</span>
        <span class="n">from</span>         <span class="s2">&quot;test@example.com&quot;</span>
        <span class="n">content_type</span> <span class="s2">&quot;multipart/mixed&quot;</span>

        <span class="n">part</span> <span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;multipart/alternative&quot;</span><span class="p">,</span> <span class="ss">:content_disposition</span> <span class="o">=&gt;</span> <span class="s2">&quot;inline&quot;</span><span class="p">,</span> <span class="ss">:headers</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">&quot;foo&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;bar&quot;</span> <span class="p">}</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
          <span class="nb">p</span><span class="o">.</span><span class="n">part</span> <span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">,</span> <span class="ss">:body</span> <span class="o">=&gt;</span> <span class="s2">&quot;test text</span><span class="se">\n</span><span class="s2">line #2&quot;</span>
          <span class="nb">p</span><span class="o">.</span><span class="n">part</span> <span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">,</span> <span class="ss">:body</span> <span class="o">=&gt;</span> <span class="s2">&quot;&lt;b&gt;test&lt;/b&gt; HTML&lt;br/&gt;</span><span class="se">\n</span><span class="s2">line #2&quot;</span>
        <span class="k">end</span>

      <span class="k">end</span>

      <span class="n">mail</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">should</span> <span class="n">be_multipart</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">2</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="ss">:content_type</span><span class="o">].</span><span class="n">string</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;text/plain&quot;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">body</span><span class="o">.</span><span class="n">decoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;test text</span><span class="se">\n</span><span class="s2">line #2&quot;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">][</span><span class="ss">:content_type</span><span class="o">].</span><span class="n">string</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;text/html&quot;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">body</span><span class="o">.</span><span class="n">decoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;&lt;b&gt;test&lt;/b&gt; HTML&lt;br/&gt;</span><span class="se">\n</span><span class="s2">line #2&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;deliver&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should return self after delivery&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">perform_deliveries</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">deliver</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="n">mail</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">DeliveryAgent</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">deliver_mail</span><span class="p">(</span><span class="n">mail</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should pass self to a delivery agent&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">delivery_handler</span> <span class="o">=</span> <span class="no">DeliveryAgent</span>
      <span class="no">DeliveryAgent</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:deliver_mail</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="n">mail</span><span class="p">)</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">deliver</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">ObserverAgent</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">delivered_email</span><span class="p">(</span><span class="n">mail</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should inform observers that the mail was sent&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">delivery_method</span> <span class="ss">:test</span>
      <span class="no">Mail</span><span class="o">.</span><span class="n">register_observer</span><span class="p">(</span><span class="no">ObserverAgent</span><span class="p">)</span>
      <span class="no">ObserverAgent</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:delivered_email</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="n">mail</span><span class="p">)</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">deliver</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should inform observers that the mail was sent, even if a delivery agent is used&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">delivery_handler</span> <span class="o">=</span> <span class="no">DeliveryAgent</span>
      <span class="no">Mail</span><span class="o">.</span><span class="n">register_observer</span><span class="p">(</span><span class="no">ObserverAgent</span><span class="p">)</span>
      <span class="no">ObserverAgent</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:delivered_email</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="n">mail</span><span class="p">)</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">deliver</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">InterceptorAgent</span>
      <span class="vc">@@intercept</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">intercept</span><span class="o">=</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="vc">@@intercept</span> <span class="o">=</span> <span class="n">val</span>
      <span class="k">end</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">delivering_email</span><span class="p">(</span><span class="n">mail</span><span class="p">)</span>
        <span class="k">if</span> <span class="vc">@@intercept</span>
          <span class="n">mail</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="s1">&#39;bob@example.com&#39;</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should pass to the interceptor the email just before it gets sent&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">delivery_method</span> <span class="ss">:test</span>
      <span class="no">Mail</span><span class="o">.</span><span class="n">register_interceptor</span><span class="p">(</span><span class="no">InterceptorAgent</span><span class="p">)</span>
      <span class="no">InterceptorAgent</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:delivering_email</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="n">mail</span><span class="p">)</span>
      <span class="no">InterceptorAgent</span><span class="o">.</span><span class="n">intercept</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">deliver</span>
      <span class="no">InterceptorAgent</span><span class="o">.</span><span class="n">intercept</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should let the interceptor that the mail was sent&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="s1">&#39;fred@example.com&#39;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">delivery_method</span> <span class="ss">:test</span>
      <span class="no">Mail</span><span class="o">.</span><span class="n">register_interceptor</span><span class="p">(</span><span class="no">InterceptorAgent</span><span class="p">)</span>
      <span class="no">InterceptorAgent</span><span class="o">.</span><span class="n">intercept</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">deliver</span>
      <span class="no">InterceptorAgent</span><span class="o">.</span><span class="n">intercept</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;bob@example.com&#39;</span><span class="o">]</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;error handling&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should collect up any of its fields&#39; errors&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Content-Transfer-Encoding: vlad</span><span class="se">\r\n</span><span class="s2">Reply-To: a b b</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_blank</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="mi">2</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">errors</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">].</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;Content-Transfer-Encoding&#39;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">errors</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="mi">1</span><span class="o">].</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;vlad&#39;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">errors</span><span class="o">[</span><span class="mi">1</span><span class="o">][</span><span class="mi">0</span><span class="o">].</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;Reply-To&#39;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">errors</span><span class="o">[</span><span class="mi">1</span><span class="o">][</span><span class="mi">1</span><span class="o">].</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;a b b&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;header case should be preserved&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should handle mail[] and keep the header case&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
      <span class="n">mail</span><span class="o">[</span><span class="s1">&#39;X-Foo-Bar&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Some custom text&quot;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="n">match</span><span class="p">(</span><span class="sr">/X-Foo-Bar: Some custom text/</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;parsing emails with non usascii in the header&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should work&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;From: &quot;Foo áëô îü&quot; &lt;extended@example.net&gt;&#39;</span><span class="p">)</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;extended@example.net&#39;</span><span class="o">]</span>
      <span class="n">mail</span><span class="o">[</span><span class="ss">:from</span><span class="o">].</span><span class="n">decoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;&quot;Foo áëô îü&quot; &lt;extended@example.net&gt;&#39;</span>
      <span class="n">mail</span><span class="o">[</span><span class="ss">:from</span><span class="o">].</span><span class="n">encoded</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;From: =?UTF-8?B?Rm9vIMOhw6vDtCDDrsO8?= &lt;extended@example.net&gt;</span><span class="se">\r\n</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;ordering messages&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should put all attachments as the last item&quot;</span> <span class="k">do</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>XXX: AFAICT, this is not actually working. The code does not appear to implement this. -- singpolyma</p></td><td class="code"><div class="highlight"><pre>      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">attachments</span><span class="o">[</span><span class="s1">&#39;image.png&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\302\302\302\302</span><span class="s2">&quot;</span>
      <span class="nb">p</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="s1">&#39;multipart/alternative&#39;</span><span class="p">)</span>
      <span class="nb">p</span><span class="o">.</span><span class="n">add_part</span><span class="p">(</span><span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="s1">&#39;text/html&#39;</span><span class="p">,</span> <span class="ss">:body</span> <span class="o">=&gt;</span> <span class="s1">&#39;HTML TEXT&#39;</span><span class="p">))</span>
      <span class="nb">p</span><span class="o">.</span><span class="n">add_part</span><span class="p">(</span><span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">,</span> <span class="ss">:body</span> <span class="o">=&gt;</span> <span class="s1">&#39;PLAIN TEXT&#39;</span><span class="p">))</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">add_part</span><span class="p">(</span><span class="nb">p</span><span class="p">)</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">encoded</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">mime_type</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;multipart/alternative&quot;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">mime_type</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;text/plain&quot;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">mime_type</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;text/html&quot;</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">mime_type</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;image/png&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;attachment query methods&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;shouldn&#39;t die with an invalid Content-Disposition header&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;Content-Disposition: invalid&#39;</span><span class="p">)</span>
      <span class="n">doing</span> <span class="p">{</span> <span class="n">mail</span><span class="o">.</span><span class="n">attachment?</span> <span class="p">}</span><span class="o">.</span><span class="n">should_not</span> <span class="n">raise_error</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;shouldn&#39;t die with an invalid Content-Type header&quot;</span> <span class="k">do</span>
      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;Content-Type: invalid/invalid; charset=&quot;iso-8859-1&quot;&#39;</span><span class="p">)</span>
      <span class="n">mail</span><span class="o">.</span><span class="n">attachment?</span>
      <span class="n">doing</span> <span class="p">{</span> <span class="n">mail</span><span class="o">.</span><span class="n">attachment?</span> <span class="p">}</span><span class="o">.</span><span class="n">should_not</span> <span class="n">raise_error</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;without_attachments!&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should delete all attachments&quot;</span> <span class="k">do</span>
      <span class="n">emails_with_attachments</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;content_disposition&#39;</span><span class="p">,</span> <span class="s1">&#39;content_location&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;with_encoded_name&#39;</span><span class="p">,</span> <span class="s1">&#39;with_quoted_filename&#39;</span><span class="o">]</span>

      <span class="n">emails_with_attachments</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">email</span><span class="o">|</span>
        <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;attachment_emails&#39;</span><span class="p">,</span> <span class="s2">&quot;attachment_</span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">.eml&quot;</span><span class="p">)))</span>
        <span class="n">mail_length_with_attachments</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">length</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">has_attachments?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">without_attachments!</span>

        <span class="n">mail_length_without_attachments</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">length</span>
        <span class="n">mail_length_without_attachments</span><span class="o">.</span><span class="n">should</span> <span class="n">be</span> <span class="o">&lt;</span> <span class="n">mail_length_with_attachments</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">has_attachments?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
      <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;replying&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;to a basic message&quot;</span> <span class="k">do</span>

      <span class="n">before</span> <span class="k">do</span>
        <span class="vi">@mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;plain_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;basic_email.eml&#39;</span><span class="p">)))</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should create a new message&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span><span class="o">.</span><span class="n">should</span> <span class="n">be_a_kind_of</span><span class="p">(</span><span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should be in-reply-to the original message&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span><span class="o">.</span><span class="n">in_reply_to</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;6B7EC235-5B17-4CA8-B2B8-39290DEB43A3@test.lindsaar.net&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should reference the original message&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span><span class="o">.</span><span class="n">references</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;6B7EC235-5B17-4CA8-B2B8-39290DEB43A3@test.lindsaar.net&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should RE: the original subject&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;RE: Testing 123&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should be sent to the original sender&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;test@lindsaar.net&#39;</span><span class="o">]</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span><span class="o">[</span><span class="ss">:to</span><span class="o">].</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;Mikel Lindsaar &lt;test@lindsaar.net&gt;&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should be sent from the original recipient&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;raasdnil@gmail.com&#39;</span><span class="o">]</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span><span class="o">[</span><span class="ss">:from</span><span class="o">].</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;Mikel Lindsaar &lt;raasdnil@gmail.com&gt;&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should accept args&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;Donald Ball &lt;donald.ball@gmail.com&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;donald.ball@gmail.com&#39;</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should accept a block&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span> <span class="p">{</span> <span class="n">from</span><span class="p">(</span><span class="s1">&#39;Donald Ball &lt;donald.ball@gmail.com&gt;&#39;</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;donald.ball@gmail.com&#39;</span><span class="o">]</span>
      <span class="k">end</span>

    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;to a message with an explicit reply-to address&quot;</span> <span class="k">do</span>

      <span class="n">before</span> <span class="k">do</span>
        <span class="vi">@mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;rfc2822&#39;</span><span class="p">,</span> <span class="s1">&#39;example06.eml&#39;</span><span class="p">)))</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should be sent to the reply-to address&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span><span class="o">[</span><span class="ss">:to</span><span class="o">].</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;&quot;Mary Smith: Personal Account&quot; &lt;smith@home.example&gt;&#39;</span>
      <span class="k">end</span>

    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;to a message with more than one recipient&quot;</span> <span class="k">do</span>

      <span class="n">before</span> <span class="k">do</span>
        <span class="vi">@mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;rfc2822&#39;</span><span class="p">,</span> <span class="s1">&#39;example03.eml&#39;</span><span class="p">)))</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should be sent from the first to address&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span><span class="o">[</span><span class="ss">:from</span><span class="o">].</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;Mary Smith &lt;mary@x.test&gt;&#39;</span>
      <span class="k">end</span>

    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;to a reply&quot;</span> <span class="k">do</span>

      <span class="n">before</span> <span class="k">do</span>
        <span class="vi">@mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fixture</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;plain_emails&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_email_reply.eml&#39;</span><span class="p">)))</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should be in-reply-to the original message&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span><span class="o">.</span><span class="n">in_reply_to</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;473FFE27.20003@xxx.org&#39;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should append to the original&#39;s references list&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span><span class="o">[</span><span class="ss">:references</span><span class="o">].</span><span class="n">message_ids</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;473FF3B8.9020707@xxx.org&#39;</span><span class="p">,</span> <span class="s1">&#39;348F04F142D69C21-291E56D292BC@xxxx.net&#39;</span><span class="p">,</span> <span class="s1">&#39;473FFE27.20003@xxx.org&#39;</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should not append another RE:&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;Re: Test reply email&quot;</span>
      <span class="k">end</span>

    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;to a reply with an in-reply-to with a single message id but no references header&quot;</span> <span class="k">do</span>

      <span class="n">before</span> <span class="k">do</span>
        <span class="vi">@mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
          <span class="n">in_reply_to</span> <span class="s1">&#39;&lt;1234@test.lindsaar.net&gt;&#39;</span>
          <span class="n">message_id</span> <span class="s1">&#39;5678@test.lindsaar.net&#39;</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should have a references consisting of the in-reply-to and message_id fields&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">reply</span><span class="o">[</span><span class="ss">:references</span><span class="o">].</span><span class="n">message_ids</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="s1">&#39;1234@test.lindsaar.net&#39;</span><span class="p">,</span> <span class="s1">&#39;5678@test.lindsaar.net&#39;</span><span class="o">]</span>
      <span class="k">end</span>

    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;to a reply with an in-reply-to with multiple message ids but no references header&quot;</span> <span class="k">do</span>

      <span class="n">before</span> <span class="k">do</span>
        <span class="vi">@mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
          <span class="n">in_reply_to</span> <span class="s1">&#39;&lt;1234@test.lindsaar.net&gt; &lt;5678@test.lindsaar.net&gt;&#39;</span>
          <span class="n">message_id</span> <span class="s1">&#39;90@test.lindsaar.net&#39;</span>
        <span class="k">end</span>
      <span class="k">end</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Behavior is actually not defined in RFC2822, so we'll just leave it empty</p></td><td class="code"><div class="highlight"><pre>      <span class="n">it</span> <span class="s2">&quot;should have no references header&quot;</span> <span class="k">do</span>
        <span class="vi">@mail</span><span class="o">.</span><span class="n">references</span><span class="o">.</span><span class="n">should</span> <span class="n">be_nil</span>
      <span class="k">end</span>

    <span class="k">end</span>

  <span class="k">end</span>

<span class="k">end</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/mail",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
