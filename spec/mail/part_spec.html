<!DOCTYPE html>
<html><head><title>joekychen/mail » spec › mail › part_spec.rb

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>part_spec.rb</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Part</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">&quot;should put content-ids into parts&quot;</span> <span class="k">do</span>
    <span class="n">part</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
      <span class="n">body</span> <span class="s2">&quot;This is Text&quot;</span>
    <span class="k">end</span>
    <span class="n">part</span><span class="o">.</span><span class="n">to_s</span>
    <span class="n">part</span><span class="o">.</span><span class="n">content_id</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_nil</span>
  <span class="k">end</span>
  
  <span class="n">it</span> <span class="s2">&quot;should preserve any content id that you put into it&quot;</span> <span class="k">do</span>
    <span class="n">part</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
      <span class="n">content_id</span> <span class="s2">&quot;&lt;thisis@acontentid&gt;&quot;</span>
      <span class="n">body</span> <span class="s2">&quot;This is Text&quot;</span>
    <span class="k">end</span>
    <span class="n">part</span><span class="o">.</span><span class="n">content_id</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;&lt;thisis@acontentid&gt;&quot;</span>
  <span class="k">end</span>
  
  <span class="n">it</span> <span class="s2">&quot;should return an inline content_id&quot;</span> <span class="k">do</span>
    <span class="n">part</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
      <span class="n">content_id</span> <span class="s2">&quot;&lt;thisis@acontentid&gt;&quot;</span>
      <span class="n">body</span> <span class="s2">&quot;This is Text&quot;</span>
    <span class="k">end</span>
    <span class="n">part</span><span class="o">.</span><span class="n">cid</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;thisis@acontentid&quot;</span>
    <span class="no">STDERR</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:puts</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s2">&quot;Part#inline_content_id is deprecated, please call Part#cid instead&quot;</span><span class="p">)</span>
    <span class="n">part</span><span class="o">.</span><span class="n">inline_content_id</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;thisis@acontentid&quot;</span>
  <span class="k">end</span>
  
  
  <span class="n">it</span> <span class="s2">&quot;should URL escape its inline content_id&quot;</span> <span class="k">do</span>
    <span class="n">part</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
      <span class="n">content_id</span> <span class="s2">&quot;&lt;thi%%sis@acontentid&gt;&quot;</span>
      <span class="n">body</span> <span class="s2">&quot;This is Text&quot;</span>
    <span class="k">end</span>
    <span class="n">part</span><span class="o">.</span><span class="n">cid</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;thi%25%25sis@acontentid&quot;</span>
    <span class="no">STDERR</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:puts</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s2">&quot;Part#inline_content_id is deprecated, please call Part#cid instead&quot;</span><span class="p">)</span>
    <span class="n">part</span><span class="o">.</span><span class="n">inline_content_id</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s2">&quot;thi%25%25sis@acontentid&quot;</span>
  <span class="k">end</span>
  
  <span class="n">it</span> <span class="s2">&quot;should add a content_id if there is none and is asked for an inline_content_id&quot;</span> <span class="k">do</span>
    <span class="n">part</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="o">.</span><span class="n">new</span>
    <span class="n">part</span><span class="o">.</span><span class="n">cid</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_nil</span>
    <span class="no">STDERR</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:puts</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s2">&quot;Part#inline_content_id is deprecated, please call Part#cid instead&quot;</span><span class="p">)</span>
    <span class="n">part</span><span class="o">.</span><span class="n">inline_content_id</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_nil</span>
  <span class="k">end</span>
  
  <span class="n">it</span> <span class="s2">&quot;should respond correctly to inline?&quot;</span> <span class="k">do</span>
    <span class="n">part</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:content_disposition</span> <span class="o">=&gt;</span> <span class="s1">&#39;attachment&#39;</span><span class="p">)</span>
    <span class="n">part</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_inline</span>

    <span class="n">part</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:content_disposition</span> <span class="o">=&gt;</span> <span class="s1">&#39;inline&#39;</span><span class="p">)</span>
    <span class="n">part</span><span class="o">.</span><span class="n">should</span> <span class="n">be_inline</span>
  <span class="k">end</span>
  
  
  <span class="n">describe</span> <span class="s2">&quot;parts that have a missing header&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should not try to init a header if there is none&quot;</span> <span class="k">do</span>
      <span class="n">part</span> <span class="o">=&lt;&lt;</span><span class="no">PARTEND</span>

<span class="sh">The original message was received at Mon, 24 Dec 2007 10:03:47 +1100</span>
<span class="sh">from 60-0-0-146.static.tttttt.com.au [60.0.0.146]</span>

<span class="sh">This message was generated by mail12.tttttt.com.au</span>

<span class="sh">   ----- The following addresses had permanent fatal errors -----</span>
<span class="sh">&lt;edwin@zzzzzzz.com&gt;</span>
<span class="sh">    (reason: 553 5.3.0 &lt;edwin@zzzzzzz.com&gt;... Unknown E-Mail Address)</span>

<span class="sh">   ----- Transcript of session follows -----</span>
<span class="sh">... while talking to mail.zzzzzz.com.:</span>
<span class="sh">&gt;&gt;&gt; DATA</span>
<span class="sh">&lt;&lt;&lt; 553 5.3.0 &lt;edwin@zzzzzzz.com&gt;... Unknown E-Mail Address</span>
<span class="sh">550 5.1.1 &lt;edwin@zzzzzzz.com&gt;... User unknown</span>
<span class="sh">&lt;&lt;&lt; 503 5.0.0 Need RCPT (recipient)</span>

<span class="sh">-- </span>
<span class="sh">This message has been scanned for viruses and</span>
<span class="sh">dangerous content by MailScanner, and is</span>
<span class="sh">believed to be clean.</span>
<span class="no">PARTEND</span>
      <span class="no">STDERR</span><span class="o">.</span><span class="n">should_not_receive</span><span class="p">(</span><span class="ss">:puts</span><span class="p">)</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
  <span class="n">describe</span> <span class="s2">&quot;delivery status reports&quot;</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">part</span> <span class="o">=&lt;&lt;</span><span class="no">ENDPART</span>
<span class="sh">Content-Type: message/delivery-status</span>

<span class="sh">Reporting-MTA: dns; mail12.rrrr.com.au</span>
<span class="sh">Received-From-MTA: DNS; 60-0-0-146.static.tttttt.com.au</span>
<span class="sh">Arrival-Date: Mon, 24 Dec 2007 10:03:47 +1100</span>

<span class="sh">Final-Recipient: RFC822; edwin@zzzzzzz.com</span>
<span class="sh">Action: failed</span>
<span class="sh">Status: 5.3.0</span>
<span class="sh">Remote-MTA: DNS; mail.zzzzzz.com</span>
<span class="sh">Diagnostic-Code: SMTP; 553 5.3.0 &lt;edwin@zzzzzzz.com&gt;... Unknown E-Mail Address</span>
<span class="sh">Last-Attempt-Date: Mon, 24 Dec 2007 10:03:53 +1100</span>
<span class="no">ENDPART</span>
      <span class="vi">@delivery_report</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should know if it is a delivery-status report&quot;</span> <span class="k">do</span>
      <span class="vi">@delivery_report</span><span class="o">.</span><span class="n">should</span> <span class="n">be_delivery_status_report_part</span>
    <span class="k">end</span>
    
    <span class="n">it</span> <span class="s2">&quot;should create a delivery_status_data header object&quot;</span> <span class="k">do</span>
      <span class="vi">@delivery_report</span><span class="o">.</span><span class="n">delivery_status_data</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_nil</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should be bounced&quot;</span> <span class="k">do</span>
      <span class="vi">@delivery_report</span><span class="o">.</span><span class="n">should</span> <span class="n">be_bounced</span>
    <span class="k">end</span>
    
    <span class="n">it</span> <span class="s2">&quot;should say action &#39;delayed&#39;&quot;</span> <span class="k">do</span>
      <span class="vi">@delivery_report</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;failed&#39;</span>
    <span class="k">end</span>
    
    <span class="n">it</span> <span class="s2">&quot;should give a final recipient&quot;</span> <span class="k">do</span>
      <span class="vi">@delivery_report</span><span class="o">.</span><span class="n">final_recipient</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;RFC822; edwin@zzzzzzz.com&#39;</span>
    <span class="k">end</span>
    
    <span class="n">it</span> <span class="s2">&quot;should give an error code&quot;</span> <span class="k">do</span>
      <span class="vi">@delivery_report</span><span class="o">.</span><span class="n">error_status</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;5.3.0&#39;</span>
    <span class="k">end</span>
    
    <span class="n">it</span> <span class="s2">&quot;should give a diagostic code&quot;</span> <span class="k">do</span>
      <span class="vi">@delivery_report</span><span class="o">.</span><span class="n">diagnostic_code</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;SMTP; 553 5.3.0 &lt;edwin@zzzzzzz.com&gt;... Unknown E-Mail Address&#39;</span>
    <span class="k">end</span>
    
    <span class="n">it</span> <span class="s2">&quot;should give a remote-mta&quot;</span> <span class="k">do</span>
      <span class="vi">@delivery_report</span><span class="o">.</span><span class="n">remote_mta</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;DNS; mail.zzzzzz.com&#39;</span>
    <span class="k">end</span>
    
    <span class="n">it</span> <span class="s2">&quot;should be retryable&quot;</span> <span class="k">do</span>
      <span class="vi">@delivery_report</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_retryable</span>
    <span class="k">end</span>

  <span class="k">end</span>
  
  <span class="n">it</span> <span class="s2">&quot;should correctly parse plain text raw source and not truncate after newlines - issue 208&quot;</span> <span class="k">do</span>
    <span class="n">plain_text</span> <span class="o">=</span> <span class="s2">&quot;First Line</span><span class="se">\n\n</span><span class="s2">Second Line</span><span class="se">\n\n</span><span class="s2">Third Line</span><span class="se">\n\n</span><span class="s2">&quot;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Note: trailing \n\n is stripped off by Mail::Part initialization</p></td><td class="code"><div class="highlight"><pre>    <span class="n">part</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Part</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">plain_text</span><span class="p">)</span>
    <span class="n">part</span><span class="o">[</span><span class="ss">:content_type</span><span class="o">].</span><span class="n">content_type</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s1">&#39;text/plain&#39;</span>
    <span class="n">part</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">should</span> <span class="n">match</span><span class="p">(</span><span class="sr">/^First Line\r\n\r\nSecond Line\r\n\r\nThird Line/</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/mail",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
